# Alphaå› å­åº“æµ‹è¯•æ¡†æ¶ä½¿ç”¨æŒ‡å—

**ç‰ˆæœ¬**: v2.4 (Phase 6)
**æœ€åæ›´æ–°**: 2026-01-07
**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯æ–‡æ¡£

---

## ğŸ“‹ ç›®å½•

1. [æµ‹è¯•æ¡†æ¶æ¦‚è¿°](#æµ‹è¯•æ¡†æ¶æ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [å•å…ƒæµ‹è¯•](#å•å…ƒæµ‹è¯•)
4. [é›†æˆæµ‹è¯•](#é›†æˆæµ‹è¯•)
5. [æ€§èƒ½æµ‹è¯•](#æ€§èƒ½æµ‹è¯•)
6. [æµ‹è¯•è¿è¡Œå™¨](#æµ‹è¯•è¿è¡Œå™¨)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
8. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## æµ‹è¯•æ¡†æ¶æ¦‚è¿°

### æ¶æ„è®¾è®¡

```
tests/
â”œâ”€â”€ unit/           # å•å…ƒæµ‹è¯• - å› å­è®¡ç®—é€»è¾‘éªŒè¯
â”‚   â”œâ”€â”€ test_base.py              # æµ‹è¯•åŸºç±»
â”‚   â”œâ”€â”€ test_alpha_peg.py         # PEGå› å­æµ‹è¯•
â”‚   â”œâ”€â”€ test_alpha_010.py         # ä»·æ ¼è¶‹åŠ¿å› å­æµ‹è¯•
â”‚   â”œâ”€â”€ test_alpha_038.py         # ä»·æ ¼å¼ºåº¦å› å­æµ‹è¯•
â”‚   â”œâ”€â”€ test_alpha_120cq.py       # 120æ—¥ä½ç½®å› å­æµ‹è¯•
â”‚   â”œâ”€â”€ test_cr_qfq.py            # åŠ¨é‡å› å­æµ‹è¯•
â”‚   â”œâ”€â”€ test_alpha_pluse.py       # é‡èƒ½å› å­æµ‹è¯•
â”‚   â”œâ”€â”€ test_bias1_qfq.py         # ä¹–ç¦»å› å­æµ‹è¯•
â”‚   â”œâ”€â”€ test_alpha_profit_employee.py      # ä»·å€¼å› å­æµ‹è¯•
â”‚   â”œâ”€â”€ test_profit_employee.py            # ä»·å€¼å› å­åˆ«åæµ‹è¯•
â”‚   â”œâ”€â”€ test_alpha_profit_employee_optimized.py  # ä¼˜åŒ–ä»·å€¼å› å­æµ‹è¯•
â”‚   â””â”€â”€ test_profit_employee_optimized.py  # ä¼˜åŒ–ä»·å€¼å› å­åˆ«åæµ‹è¯•
â”‚
â”œâ”€â”€ integration/    # é›†æˆæµ‹è¯• - ç«¯åˆ°ç«¯æµç¨‹éªŒè¯
â”‚   â””â”€â”€ test_end_to_end.py        # å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•
â”‚
â”œâ”€â”€ performance/    # æ€§èƒ½æµ‹è¯• - åŸºå‡†å’Œå‹åŠ›æµ‹è¯•
â”‚   â””â”€â”€ test_benchmark.py         # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚
â”œâ”€â”€ fixtures/       # æµ‹è¯•æ•°æ®å’Œmockå¯¹è±¡
â”œâ”€â”€ helpers/        # æµ‹è¯•è¾…åŠ©å·¥å…·
â”œâ”€â”€ reports/        # æµ‹è¯•æŠ¥å‘Šè¾“å‡º
â”‚
â”œâ”€â”€ __init__.py
â”œâ”€â”€ conftest.py     # pytesté…ç½®å’Œfixtures
â”œâ”€â”€ pytest.ini      # pytesté…ç½®æ–‡ä»¶
â””â”€â”€ run_all_tests.py  # ä¸€é”®æµ‹è¯•è¿è¡Œå™¨
```

### æµ‹è¯•è¦†ç›–èŒƒå›´

| æµ‹è¯•ç±»å‹ | è¦†ç›–å› å­ | æµ‹è¯•ç»´åº¦ | æ–‡ä»¶æ•°é‡ |
|---------|---------|---------|---------|
| å•å…ƒæµ‹è¯• | 11ä¸ªå› å­ | 7ä¸ªæµ‹è¯•ç»´åº¦ | 12ä¸ªæ–‡ä»¶ |
| é›†æˆæµ‹è¯• | æ‰€æœ‰å› å­ | 8ä¸ªæµç¨‹åœºæ™¯ | 1ä¸ªæ–‡ä»¶ |
| æ€§èƒ½æµ‹è¯• | æ‰€æœ‰å› å­ | 4ä¸ªè§„æ¨¡çº§åˆ« | 1ä¸ªæ–‡ä»¶ |

---

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
cd /home/zcy/alphaå› å­åº“

# å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
pip install pytest pandas numpy
```

### 2. è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# æ–¹å¼1: ä½¿ç”¨æµ‹è¯•è¿è¡Œå™¨ï¼ˆæ¨èï¼‰
python tests/run_all_tests.py
# ç„¶åé€‰æ‹© 1 (è¿è¡Œæ‰€æœ‰æµ‹è¯•)

# æ–¹å¼2: ç›´æ¥ä½¿ç”¨pytest
python -m pytest tests/ -v --tb=short

# æ–¹å¼3: ä»…è¿è¡Œå•å…ƒæµ‹è¯•
python -m pytest tests/unit/ -v

# æ–¹å¼4: ä»…è¿è¡Œé›†æˆæµ‹è¯•
python tests/integration/test_end_to_end.py

# æ–¹å¼5: ä»…è¿è¡Œæ€§èƒ½æµ‹è¯•
python tests/performance/test_benchmark.py
```

### 3. æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š

æµ‹è¯•æŠ¥å‘Šä¼šè‡ªåŠ¨è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œæ€§èƒ½æµ‹è¯•è¿˜ä¼šç”ŸæˆåŸºå‡†æ–‡ä»¶ã€‚

---

## å•å…ƒæµ‹è¯•

### æµ‹è¯•åŸºç±»

æ‰€æœ‰å› å­æµ‹è¯•éƒ½ç»§æ‰¿è‡ª `FactorTestBase`ï¼Œæä¾›æ ‡å‡†åŒ–çš„æµ‹è¯•èƒ½åŠ›ï¼š

```python
from tests.unit.test_base import FactorTestBase

class TestMyFactor(FactorTestBase):
    factor_name = "my_factor"
    factor_class = MyFactorClass
    required_columns = ['close', 'volume']

    def generate_test_data(self, n_stocks=20, n_dates=30):
        # ç”Ÿæˆæµ‹è¯•æ•°æ®
        pass
```

### 7å¤§æµ‹è¯•ç»´åº¦

#### 1. æ•°æ®éªŒè¯æµ‹è¯•
```python
def test_data_validation(self):
    """æµ‹è¯•ç©ºæ•°æ®ã€ç¼ºå°‘åˆ—ã€æœ‰æ•ˆæ•°æ®"""
```

#### 2. è®¡ç®—é€»è¾‘æµ‹è¯•
```python
def test_calculation_logic(self):
    """æµ‹è¯•è¾“å‡ºæ ¼å¼ã€æ•°æ®å®Œæ•´æ€§ã€å› å­å€¼èŒƒå›´"""
```

#### 3. è¾¹ç•Œæ¡ä»¶æµ‹è¯•
```python
def test_boundary_conditions(self):
    """æµ‹è¯•å•è‚¡ç¥¨ã€å•æ—¥æœŸã€æç«¯å€¼"""
```

#### 4. å¼‚å¸¸å¤„ç†æµ‹è¯•
```python
def test_exception_handling(self):
    """æµ‹è¯•æ— æ•ˆæ•°æ®ç±»å‹ã€ç¼ºå¤±å…³é”®æ•°æ®"""
```

#### 5. æ€§èƒ½åŸºå‡†æµ‹è¯•
```python
def test_performance_benchmark(self):
    """æµ‹è¯•å°ã€ä¸­ã€å¤§è§„æ¨¡æ•°æ®æ€§èƒ½"""
```

#### 6. ç»“æœä¸€è‡´æ€§æµ‹è¯•
```python
def test_result_consistency(self):
    """æµ‹è¯•å¤šæ¬¡è®¡ç®—ç»“æœä¸€è‡´æ€§"""
```

#### 7. ç»Ÿè®¡ç‰¹æ€§æµ‹è¯•
```python
def test_statistical_properties(self):
    """æµ‹è¯•å‡å€¼ã€æ ‡å‡†å·®ã€åˆ†å¸ƒèŒƒå›´"""
```

### è¿è¡Œå•ä¸ªå› å­æµ‹è¯•

```bash
# æµ‹è¯•PEGå› å­
python -m pytest tests/unit/test_alpha_peg.py -v

# æµ‹è¯•å¤šä¸ªå› å­
python -m pytest tests/unit/test_alpha_peg.py tests/unit/test_alpha_010.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
python -m pytest tests/unit/test_alpha_peg.py::TestAlphaPegFactor::test_peg_calculation -v
```

---

## é›†æˆæµ‹è¯•

### æµ‹è¯•åœºæ™¯

`test_end_to_end.py` åŒ…å«8ä¸ªå®Œæ•´çš„æµ‹è¯•åœºæ™¯ï¼š

1. **å®Œæ•´å› å­è®¡ç®—æµç¨‹** - æ‰€æœ‰11ä¸ªå› å­çš„å®Œæ•´è®¡ç®—
2. **å¤šå› å­ç»„åˆ** - å› å­åˆå¹¶å’Œç»¼åˆå¾—åˆ†è®¡ç®—
3. **å› å­æ’å** - CSRankè·¨æˆªé¢æ’å
4. **æ•°æ®éªŒè¯æµç¨‹** - å„ç§æ— æ•ˆæ•°æ®å¤„ç†
5. **è´Ÿè½½æ€§èƒ½æµ‹è¯•** - å¤§è§„æ¨¡æ•°æ®å¤„ç†
6. **é”™è¯¯å¤„ç†æµç¨‹** - å¼‚å¸¸æƒ…å†µå¤„ç†
7. **å› å­åˆ«åä¸€è‡´æ€§** - åˆ«åä¸åŸåç»“æœä¸€è‡´
8. **å®Œæ•´å·¥ä½œæµç¨‹** - ä»æ•°æ®åˆ°ç»“æœçš„å®Œæ•´é“¾æ¡

### è¿è¡Œé›†æˆæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
python tests/integration/test_end_to_end.py

# è¾“å‡ºç¤ºä¾‹:
# ================================================================================
# æµ‹è¯•1: å®Œæ•´å› å­è®¡ç®—æµç¨‹
# ================================================================================
# âœ… alpha_010: 900æ¡è®°å½•
# âœ… alpha_038: 900æ¡è®°å½•
# ...
```

---

## æ€§èƒ½æµ‹è¯•

### æµ‹è¯•è§„æ¨¡

| è§„æ¨¡ | è‚¡ç¥¨æ•° | æ—¥æœŸæ•° | é€‚ç”¨åœºæ™¯ |
|-----|--------|--------|---------|
| å°è§„æ¨¡ | 10 | 10 | å¿«é€ŸéªŒè¯ |
| ä¸­è§„æ¨¡ | 50 | 30 | æ ‡å‡†æµ‹è¯• |
| å¤§è§„æ¨¡ | 100 | 60 | å‹åŠ›æµ‹è¯• |
| è¶…å¤§è§„æ¨¡ | 200 | 120 | æé™æµ‹è¯• |

### æ€§èƒ½æŒ‡æ ‡

- **è®¡ç®—é€Ÿåº¦** - å› å­è®¡ç®—è€—æ—¶ï¼ˆç§’ï¼‰
- **å†…å­˜ä½¿ç”¨** - æ•°æ®å†…å­˜å ç”¨ï¼ˆMBï¼‰
- **æ‰©å±•æ€§** - æ•°æ®é‡å¢é•¿å¯¹æ€§èƒ½çš„å½±å“
- **ç“¶é¢ˆåˆ†æ** - è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ

### è¿è¡Œæ€§èƒ½æµ‹è¯•

```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•
python tests/performance/test_benchmark.py

# é¦–æ¬¡è¿è¡Œä¼šåˆ›å»ºåŸºå‡†æ–‡ä»¶ performance_baseline.json
# åç»­è¿è¡Œä¼šå¯¹æ¯”åŸºå‡†ï¼Œæ£€æµ‹æ€§èƒ½å›å½’
```

### æ€§èƒ½æŠ¥å‘Šç¤ºä¾‹

```
ğŸ“Š ä¸­è§„æ¨¡æµ‹è¯•: 50è‚¡ç¥¨Ã—30å¤©
  âœ… alpha_peg: 0.0234s
  âœ… alpha_010: 0.0156s
  âœ… alpha_038: 0.0189s
  ...

ğŸ“Š æ€§èƒ½è¶‹åŠ¿åˆ†æ:
  alpha_peg: æ‰©å±•æ€§æŒ‡æ•° 1.2 (ä¼˜ç§€)
  alpha_010: æ‰©å±•æ€§æŒ‡æ•° 1.5 (è‰¯å¥½)
  ...
```

---

## æµ‹è¯•è¿è¡Œå™¨

### ä¸€é”®è¿è¡Œå™¨

`run_all_tests.py` æä¾›äº¤äº’å¼æµ‹è¯•è¿è¡Œï¼š

```bash
python tests/run_all_tests.py
```

**èœå•é€‰é¡¹**:
1. è¿è¡Œæ‰€æœ‰æµ‹è¯• (æ¨è)
2. ä»…è¿è¡Œå•å…ƒæµ‹è¯•
3. ä»…è¿è¡Œé›†æˆæµ‹è¯•
4. ä»…è¿è¡Œæ€§èƒ½æµ‹è¯•
5. ä»…æ£€æŸ¥æµ‹è¯•è¦†ç›–
0. é€€å‡º

### è‡ªåŠ¨åŒ–è¿è¡Œ

```bash
# è‡ªåŠ¨è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
python tests/run_all_tests.py <<< "1"
```

---

## æœ€ä½³å®è·µ

### 1. å¼€å‘æ–°å› å­æ—¶

```python
# 1. åˆ›å»ºæµ‹è¯•æ–‡ä»¶
# tests/unit/test_my_factor.py

from tests.unit.test_base import FactorTestBase
from factors.calculation import MyFactor

class TestMyFactor(FactorTestBase):
    factor_name = "my_factor"
    factor_class = MyFactor
    required_columns = ['close', 'volume']

    def generate_test_data(self, n_stocks=20, n_dates=30):
        # å®ç°æ•°æ®ç”Ÿæˆ
        pass

    # æ·»åŠ ç‰¹å®šæµ‹è¯•
    def test_my_specific_logic(self):
        # æµ‹è¯•ç‰¹å®šé€»è¾‘
        pass
```

### 2. æµ‹è¯•æ•°æ®ç”ŸæˆåŸåˆ™

- **éšæœºç§å­å›ºå®š** - ç¡®ä¿å¯é‡å¤æ€§
- **è¦†ç›–è¾¹ç•Œæƒ…å†µ** - åŒ…å«æç«¯å€¼ã€ç¼ºå¤±å€¼
- **æ•°æ®è§„æ¨¡é€‚ä¸­** - å¹³è¡¡é€Ÿåº¦å’Œè¦†ç›–ç‡
- **ç¬¦åˆå®é™…æ ¼å¼** - ä¸çœŸå®æ•°æ®ç»“æ„ä¸€è‡´

### 3. æµ‹è¯•å‘½åè§„èŒƒ

```python
# å¥½çš„å‘½å
def test_peg_calculation(self):
def test_zero_growth_rate(self):
def test_extreme_pe_values(self):

# é¿å…
def test1(self):
def test_calc(self):
```

### 4. æ–­è¨€æœ€ä½³å®è·µ

```python
# å…·ä½“çš„é”™è¯¯ä¿¡æ¯
assert result is True, "åº”è¯¥éªŒè¯é€šè¿‡"

# æ£€æŸ¥æ•°æ®ç±»å‹
assert isinstance(result, pd.DataFrame), "ç»“æœåº”è¯¥æ˜¯DataFrame"

# æ£€æŸ¥å¿…è¦åˆ—
assert 'factor' in result.columns, "åº”è¯¥åŒ…å«å› å­å€¼åˆ—"

# æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
assert len(result) > 0, "åº”è¯¥æœ‰è®¡ç®—ç»“æœ"
assert not result['factor'].isna().all(), "å› å­å€¼ä¸åº”è¯¥å…¨ä¸ºç©º"
```

### 5. æ€§èƒ½æµ‹è¯•å»ºè®®

- **é¢„çƒ­è¿è¡Œ** - é¿å…JITç¼–è¯‘å½±å“
- **å¤šæ¬¡æµ‹é‡** - å–å¹³å‡å€¼
- **éš”ç¦»ç¯å¢ƒ** - é¿å…å…¶ä»–è¿›ç¨‹å¹²æ‰°
- **è®°å½•åŸºå‡†** - æŒç»­ç›‘æ§æ€§èƒ½å˜åŒ–

---

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. å¯¼å…¥é”™è¯¯

```bash
# é”™è¯¯: ModuleNotFoundError
# è§£å†³: ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
cd /home/zcy/alphaå› å­åº“
export PYTHONPATH=/home/zcy/alphaå› å­åº“:$PYTHONPATH
```

#### 2. å› å­æœªæ³¨å†Œ

```python
# é”™è¯¯: ValueError: å› å­æœªæ³¨å†Œ
# è§£å†³: å…ˆæ³¨å†Œå› å­
from scripts.factors.register_factors import register_all_factors
register_all_factors()
```

#### 3. æµ‹è¯•æ•°æ®ä¸è¶³

```python
# é”™è¯¯: æ•°æ®ä¸è¶³å¯¼è‡´è®¡ç®—å¤±è´¥
# è§£å†³: å¢åŠ æµ‹è¯•æ•°æ®é‡
def generate_test_data(self, n_stocks=50, n_dates=60):  # å¢åŠ æ•°é‡
```

#### 4. æ€§èƒ½æµ‹è¯•è¶…æ—¶

```bash
# é”™è¯¯: æµ‹è¯•è¶…æ—¶
# è§£å†³: å‡å°‘æ•°æ®è§„æ¨¡æˆ–å¢åŠ è¶…æ—¶æ—¶é—´
# åœ¨ pytest.ini ä¸­è°ƒæ•´ timeout = 300
```

### è°ƒè¯•æŠ€å·§

```python
# 1. æ‰“å°ä¸­é—´ç»“æœ
def test_debug(self):
    factor = self.factor_class()
    data = self.generate_test_data()
    result = factor.calculate(data)
    print(f"ç»“æœå½¢çŠ¶: {result.shape}")
    print(f"å‰5è¡Œ:\n{result.head()}")
    print(f"ç»Ÿè®¡:\n{result['factor'].describe()}")

# 2. å•æ­¥è°ƒè¯•
import pdb; pdb.set_trace()

# 3. æ£€æŸ¥æ•°æ®
assert not data.isna().any().any(), "æ•°æ®ä¸åº”åŒ…å«NaN"
```

---

## æµ‹è¯•æŠ¥å‘Š

### æŠ¥å‘Šä½ç½®

```
tests/reports/
â”œâ”€â”€ pytest_report.json      # pytest JSONæŠ¥å‘Š
â”œâ”€â”€ test_run.log           # è¿è¡Œæ—¥å¿—
â””â”€â”€ performance_baseline.json  # æ€§èƒ½åŸºå‡†
```

### æŠ¥å‘Šå†…å®¹

1. **æµ‹è¯•ç»Ÿè®¡** - é€šè¿‡/å¤±è´¥æ•°é‡
2. **æ€§èƒ½æ•°æ®** - è€—æ—¶ã€å†…å­˜ä½¿ç”¨
3. **é”™è¯¯è¯¦æƒ…** - å¤±è´¥åŸå› å’Œå †æ ˆ
4. **åŸºå‡†å¯¹æ¯”** - æ€§èƒ½å˜åŒ–è¶‹åŠ¿

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¸»è¦æ›´æ–° |
|-----|------|---------|
| v2.4 | 2026-01-07 | Phase 6 - å®Œæ•´æµ‹è¯•æ¡†æ¶ |
| v2.3 | 2026-01-06 | Phase 5 - è¯„ä¼°ç³»ç»Ÿ |
| v2.2 | 2026-01-05 | Phase 4 - å› å­ä¼˜åŒ– |
| v2.1 | 2026-01-04 | Phase 3 - æ ¸å¿ƒå› å­ |
| v2.0 | 2026-01-03 | Phase 2 - åŸºç¡€æ¶æ„ |

---

## è”ç³»ä¸æ”¯æŒ

- **é¡¹ç›®ä½ç½®**: `/home/zcy/alphaå› å­åº“`
- **æµ‹è¯•æ¡†æ¶**: `tests/` ç›®å½•
- **æ–‡æ¡£**: `tests/TEST_GUIDE.md`

---

**æ–‡æ¡£ç»´æŠ¤**: è¯·åœ¨æ¯æ¬¡Phaseæ›´æ–°æ—¶åŒæ­¥æ›´æ–°æ­¤æ–‡æ¡£
**æœ€åéªŒè¯**: 2026-01-07
