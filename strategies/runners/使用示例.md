# èšå®½ç­–ç•¥V3 - æ•°æ®åº“ç‰ˆä½¿ç”¨ç¤ºä¾‹

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1: è¿è¡Œå¿«é€Ÿæµ‹è¯•

```bash
cd /home/zcy/alpha006_20251223/strategies/runners
python quick_test.py
```

è¿™ä¼šæµ‹è¯•ï¼š
- âœ… æ•°æ®åº“è¿æ¥
- âœ… è‚¡ç¥¨æ± è·å–
- âœ… ä»·æ ¼æ•°æ®
- âœ… å› å­æ•°æ®
- âœ… PEGè®¡ç®—

### æ­¥éª¤2: å•æ—¥æµ‹è¯•

```bash
# æµ‹è¯•æœ€è¿‘äº¤æ˜“æ—¥
python strategy_executor.py --mode test

# æˆ–æŒ‡å®šæ—¥æœŸ
python strategy_executor.py --mode test --date 2025-01-03
```

### æ­¥éª¤3: è¿è¡Œå›æµ‹

```bash
# å›æµ‹2024å¹´12æœˆåˆ°2025å¹´1æœˆ
python strategy_executor.py --mode backtest --start 2024-12-01 --end 2025-01-31
```

---

## ğŸ“‹ å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1: éªŒè¯ç­–ç•¥åœ¨ç‰¹å®šæ—¥æœŸçš„è¡¨ç°

```bash
# æµ‹è¯•2025å¹´1æœˆ6æ—¥ï¼ˆè°ƒä»“æ—¥ï¼‰
python strategy_executor.py --mode test --date 2025-01-06
```

**é¢„æœŸè¾“å‡º**:
```
==================== å•æ—¥æµ‹è¯•: 2025-01-06 ====================
ç­–ç•¥åˆå§‹åŒ–å®Œæˆï¼šæ¯æœˆ6æ—¥è°ƒä»“ï¼Œæœ€å¤§æŒä»“5åª

ã€2025-01-06ã€‘æ‰§è¡Œè°ƒä»“...
===== å¼€å§‹ç­›é€‰æµç¨‹ï¼ˆåˆå§‹è‚¡ç¥¨æ•°ï¼š1200ï¼‰ =====
[ä¸»å¤„ç†] æ¢æ‰‹ç‡ç­›é€‰ï¼šä½¿ç”¨40.0%åˆ†ä½æ•°é˜ˆå€¼(2.45)ï¼Œä¿ç•™ 480 åªè‚¡ç¥¨
[ä¸»å¤„ç†] ä»·æ ¼æµåŠ¨æ€§ç­›é€‰ï¼šä¿ç•™ 356 åªè‚¡ç¥¨
[ä¸»å¤„ç†] PEGå› å­ç­›é€‰ï¼šä¿ç•™ 128 åªè‚¡ç¥¨
[ä¸»å¤„ç†] CR20å› å­ç­›é€‰å®Œæˆï¼šå…±ä¿ç•™ 45 åª
[å•è‚¡ç¥¨ç­›é€‰è¿›åº¦ï¼š45/45ï¼Œå·²åˆæ ¼ï¼š8åª

ã€è°ƒä»“æ€»ç»“ã€‘è€—æ—¶12.56ç§’ï¼Œæœ€ç»ˆæŒä»“8åª
```

---

### åœºæ™¯2: å›æµ‹å†å²è¡¨ç°

```bash
# å›æµ‹2024å¹´å…¨å¹´ï¼ˆæ¯æœˆ6æ—¥è°ƒä»“ï¼‰
python strategy_executor.py --mode backtest --start 2024-01-01 --end 2024-12-31 --rebalance 6
```

**è¿è¡Œè¿‡ç¨‹**:
```
å¼€å§‹å›æµ‹: 2024-01-01 è‡³ 2024-12-31
è°ƒä»“æ—¥: æ¯æœˆ6æ—¥

ã€2024-01-06ã€‘æ‰§è¡Œè°ƒä»“...
[ç­›é€‰å®Œæˆ] æœ€ç»ˆæŒä»“: 7åª

ã€2024-02-06ã€‘æ‰§è¡Œè°ƒä»“...
[ç­›é€‰å®Œæˆ] æœ€ç»ˆæŒä»“: 8åª

...

ã€2024-12-06ã€‘æ‰§è¡Œè°ƒä»“...
[ç­›é€‰å®Œæˆ] æœ€ç»ˆæŒä»“: 9åª

å›æµ‹å®Œæˆï¼å…±æ‰§è¡Œ12æ¬¡è°ƒä»“
```

---

### åœºæ™¯3: åˆ†æå•åªè‚¡ç¥¨å› å­

```bash
# åˆ†æå®å¾·æ—¶ä»£åœ¨2025-01-03çš„å› å­
python strategy_executor.py --mode factor --date 2025-01-03 --stock 300750.SZ
```

**è¾“å‡º**:
```
==================== å› å­åˆ†æ: 300750.SZ @ 2025-01-03 ====================

1. è·å–è‚¡ç¥¨æ± ...
   åˆ›ä¸šæ¿è‚¡ç¥¨: 520åª
   300750.SZ åœ¨è‚¡ç¥¨æ± ä¸­ âœ“

2. è·å–ä»·æ ¼æ•°æ®...
   æ•°æ®é•¿åº¦: 120å¤©
   æœ€è¿‘5æ—¥æ”¶ç›˜ä»·: [156.23, 158.45, 157.89, 160.12, 162.34]

3. è·å–æ¢æ‰‹ç‡æ•°æ®...
   æ•°æ®é•¿åº¦: 120å¤©
   æœ€è¿‘5æ—¥æ¢æ‰‹ç‡: [1.23, 1.56, 1.45, 1.78, 1.92]

4. è·å–å› å­æ•°æ®...
   PEGæ•°æ®: 45å¤©
   æœ€è¿‘PEG: [1.45, 1.48, 1.52, 1.55, 1.58]
   CR20æ•°æ®: 45å¤©
   æœ€è¿‘CR20: [92.3, 94.5, 96.8, 98.2, 100.5]
```

---

### åœºæ™¯4: æ£€æŸ¥æ•°æ®åº“çŠ¶æ€

```bash
python strategy_executor.py --mode dbcheck
```

**è¾“å‡º**:
```
==================== æ•°æ®åº“è¿æ¥æ£€æŸ¥ ====================
âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸
  daily_kline: è¿æ¥æ­£å¸¸
  daily_basic: è¿æ¥æ­£å¸¸
  stk_factor_pro: è¿æ¥æ­£å¸¸
  sw_industry: è¿æ¥æ­£å¸¸

æœ€è¿‘äº¤æ˜“æ—¥æœŸ: 20250103
```

---

## ğŸ¯ Pythonä»£ç è°ƒç”¨

### æ–¹å¼1: ç›´æ¥è°ƒç”¨ç­–ç•¥å‡½æ•°

```python
from strategies.runners.èšå®½ç­–ç•¥V3_æ•°æ®åº“ç‰ˆ import (
    initialize, select_and_adjust, Context
)
from datetime import datetime

# åˆ›å»ºä¸Šä¸‹æ–‡
test_date = datetime(2025, 1, 6)
context = Context(test_date)

# åˆå§‹åŒ–ç­–ç•¥
initialize(context)

# æ‰§è¡Œè°ƒä»“
select_and_adjust(context)

# æŸ¥çœ‹æŒä»“
for code, pos in context.portfolio.positions.items():
    if pos.total_amount > 0:
        print(f"{code}: {pos.total_amount}è‚¡, æˆæœ¬: {pos.avg_cost:.2f}")
```

### æ–¹å¼2: æ‰¹é‡å›æµ‹

```python
from strategies.runners.strategy_executor import run_backtest

# å›æµ‹2024å¹´
run_backtest('2024-01-01', '2024-12-31', rebalance_day=6)

# å›æµ‹2024å¹´Q4
run_backtest('2024-10-01', '2024-12-31', rebalance_day=6)
```

### æ–¹å¼3: è‡ªå®šä¹‰ç­›é€‰æµç¨‹

```python
from strategies.runners.èšå®½ç­–ç•¥V3_æ•°æ®åº“ç‰ˆ import (
    get_stock_pool, batch_get_price_data, get_turnover_data,
    get_factor_data_batch, run_screening_pipeline
)
from datetime import datetime

# 1. è·å–è‚¡ç¥¨æ± 
context = Context(datetime(2025, 1, 6))
stocks = get_stock_pool(context, debug=True, is_mainboard=False, min_listed_days=365)

# 2. è·å–æ•°æ®
price_data = batch_get_price_data(stocks, context.current_dt, 120, debug=False)
turnover_data = get_turnover_data(stocks, context.current_dt.date(), 120, debug=False)
factor_data = get_factor_data_batch(stocks, '20241115', '20250106', ['PEG', 'CR20'], debug=False)

# 3. è¿è¡Œç­›é€‰
qualified = run_screening_pipeline(
    stocks, price_data, turnover_data, factor_data,
    g.params, None, '000300.SH', False, context
)

print(f"ç­›é€‰å‡º {len(qualified)} åªåˆæ ¼è‚¡ç¥¨")
```

---

## ğŸ”§ å‚æ•°è°ƒä¼˜ç¤ºä¾‹

### æ¿€è¿›ç­–ç•¥ï¼ˆè¿½æ±‚é«˜æ”¶ç›Šï¼‰

```python
# åœ¨ç­–ç•¥æ–‡ä»¶ä¸­ä¿®æ”¹
g.params.update({
    'turnover_quantile': 0.3,      # æ›´é«˜çš„æ¢æ‰‹ç‡é˜ˆå€¼ï¼ˆ30%åˆ†ä½ï¼‰
    'min_turnover': 5,             # æœ€ä½æ¢æ‰‹ç‡5%
    'max_position': 8,             # æ›´å¤šæŒä»“
    'pass_score': 4,               # é™ä½åˆæ ¼çº¿
})
```

### ä¿å®ˆç­–ç•¥ï¼ˆæ§åˆ¶é£é™©ï¼‰

```python
g.params.update({
    'turnover_quantile': 0.6,      # æ›´ä½çš„æ¢æ‰‹ç‡é˜ˆå€¼ï¼ˆ60%åˆ†ä½ï¼‰
    'stop_loss_ratio': 0.08,       # 8%æ­¢æŸ
    'max_portfolio_drawdown': 10,  # 10%æœ€å¤§å›æ’¤
    'max_position': 3,             # æ›´å°‘æŒä»“
    'pass_score': 6,               # æé«˜åˆæ ¼çº¿
})
```

### åˆ›ä¸šæ¿ä¸“æ³¨

```python
# åªç­›é€‰åˆ›ä¸šæ¿
def custom_filter():
    context = Context(datetime(2025, 1, 6))
    gem_stocks = get_stock_pool(context, debug=False, is_mainboard=False)

    # åªå¤„ç†åˆ›ä¸šæ¿
    price_data = batch_get_price_data(gem_stocks, context.current_dt, 120, debug=False)
    turnover_data = get_turnover_data(gem_stocks, context.current_dt.date(), 120, debug=False)
    factor_data = get_factor_data_batch(gem_stocks, '20241115', '20250106', ['PEG', 'CR20'], debug=False)

    qualified = run_screening_pipeline(
        gem_stocks, price_data, turnover_data, factor_data,
        g.params, None, '000300.SH', False, context
    )

    return qualified
```

---

## ğŸ“Š ç»“æœåˆ†æ

### æŸ¥çœ‹ç­›é€‰æ—¥å¿—

ç­–ç•¥è¿è¡Œæ—¶ä¼šè¾“å‡ºè¯¦ç»†çš„ç­›é€‰è¿‡ç¨‹ï¼š

```
[ä¸»å¤„ç†] æ¢æ‰‹ç‡ç­›é€‰ï¼šä½¿ç”¨40.0%åˆ†ä½æ•°é˜ˆå€¼(2.45)ï¼Œä¿ç•™ 480 åªè‚¡ç¥¨
  - å¹³å‡æ¢æ‰‹ç‡é˜ˆå€¼: 2.45%
  - é€šè¿‡æ•°é‡: 480åª

[ä¸»å¤„ç†] ä»·æ ¼æµåŠ¨æ€§ç­›é€‰ï¼šä¿ç•™ 356 åªè‚¡ç¥¨
  - æœ€ä½æˆäº¤é‡: 5000æ‰‹
  - æœ€å¤§è·Œå¹…: 30%
  - é€šè¿‡æ•°é‡: 356åª

[ä¸»å¤„ç†] PEGå› å­ç­›é€‰ï¼šä¿ç•™ 128 åªè‚¡ç¥¨
  - è¡Œä¸šåŠ¨æ€é˜ˆå€¼: 1.1-3.0
  - é€šè¿‡æ•°é‡: 128åª

[ä¸»å¤„ç†] CR20å› å­ç­›é€‰å®Œæˆï¼šå…±ä¿ç•™ 45 åª
  - åˆ›ä¸šæ¿: 12åª
  - éåˆ›ä¸šæ¿: 33åª

[å•è‚¡ç¥¨ç­›é€‰è¿›åº¦ï¼š45/45ï¼Œå·²åˆæ ¼ï¼š8åª
  - æ¢æ‰‹ç‡è„‰å†²: 3åª (+2åˆ†)
  - ä»·æ ¼ä½ä½: 5åª (+1åˆ†)
  - å‡çº¿è¶‹åŠ¿: 6åª (+1-2åˆ†)
  - è·‘èµ¢æŒ‡æ•°: 4åª (+1åˆ†)
```

### å¯¼å‡ºç»“æœ

```python
from strategies.runners.èšå®½ç­–ç•¥V3_æ•°æ®åº“ç‰ˆ import qualified_stocks

# å¯¼å‡ºä¸ºCSV
import pandas as pd
df = pd.DataFrame(qualified_stocks)
df.to_csv('ç­›é€‰ç»“æœ.csv', index=False, encoding='utf-8-sig')

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
print(df[['code', 'score', 'avg_turnover', 'recent_peg', 'cr20_growth']])
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. å¯ç”¨ç¼“å­˜

```python
from core.utils.data_loader import DataLoader

# åˆ›å»ºå¸¦ç¼“å­˜çš„æ•°æ®åŠ è½½å™¨
data_loader = DataLoader(use_cache=True, cache_expiry=3600)  # 1å°æ—¶è¿‡æœŸ
```

### 2. å‡å°‘è°ƒè¯•è¾“å‡º

```python
g.params['debug'] = False  # å…³é—­è°ƒè¯•æ—¥å¿—
```

### 3. è°ƒæ•´æ‰¹æ¬¡å¤§å°

```python
# åœ¨ç­–ç•¥æ–‡ä»¶ä¸­ä¿®æ”¹
MAX_WORKERS = 2  # å‡å°‘çº¿ç¨‹æ•°ï¼ˆå¦‚æœå†…å­˜ä¸è¶³ï¼‰
batch_size = 100  # å‡å°æ‰¹æ¬¡å¤§å°
```

---

## ğŸ› è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å…·ä½“è‚¡ç¥¨çš„ç­›é€‰è¿‡ç¨‹

```python
# åœ¨ç­–ç•¥ä¸­æ·»åŠ è°ƒè¯•ä»£ç 
stock = '300001.SZ'
print(f"\nè°ƒè¯• {stock}:")

# æ£€æŸ¥æ˜¯å¦åœ¨è‚¡ç¥¨æ± 
if stock in stock_pool:
    print("âœ“ åœ¨è‚¡ç¥¨æ± ä¸­")

    # æ£€æŸ¥æ¢æ‰‹ç‡
    if stock in turnover_data.columns:
        avg_turnover = turnover_data[stock].mean()
        print(f"  å¹³å‡æ¢æ‰‹ç‡: {avg_turnover:.2f}%")

    # æ£€æŸ¥ä»·æ ¼æ•°æ®
    if stock in price_data['close'].columns:
        current_price = price_data['close'][stock].iloc[-1]
        print(f"  å½“å‰ä»·æ ¼: {current_price:.2f}")
```

### 2. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§

```python
from strategies.runners.èšå®½ç­–ç•¥V3_æ•°æ®åº“ç‰ˆ import data_loader

# éªŒè¯æ•°æ®è´¨é‡
result = data_loader.validate_data_quality(price_data['close'], 'ä»·æ ¼æ•°æ®')
print(result)
```

---

## ğŸ“ å¸¸ç”¨å‘½ä»¤æ±‡æ€»

```bash
# 1. æ•°æ®åº“æ£€æŸ¥
python strategy_executor.py --mode dbcheck

# 2. å•æ—¥æµ‹è¯•
python strategy_executor.py --mode test
python strategy_executor.py --mode test --date 2025-01-03

# 3. å›æµ‹
python strategy_executor.py --mode backtest --start 2024-12-01 --end 2025-01-31

# 4. å› å­åˆ†æ
python strategy_executor.py --mode factor --date 2025-01-03 --stock 300750.SZ

# 5. å¿«é€Ÿæµ‹è¯•
python quick_test.py
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **é¦–æ¬¡ä½¿ç”¨**: å…ˆè¿è¡Œ `quick_test.py` éªŒè¯ç¯å¢ƒ
2. **å•æ—¥æµ‹è¯•**: ä½¿ç”¨ `--mode test` éªŒè¯ç­–ç•¥é€»è¾‘
3. **å†å²å›æµ‹**: ä½¿ç”¨ `--mode backtest` è¯„ä¼°å†å²è¡¨ç°
4. **å‚æ•°è°ƒä¼˜**: ä¿®æ”¹ç­–ç•¥æ–‡ä»¶ä¸­çš„ `g.params`
5. **ç»“æœåˆ†æ**: æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼Œåˆ†æç­›é€‰è¿‡ç¨‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¥æœŸ**: 2026-01-04
