# CR20因子计算原理详解

## 📊 CR20是什么？

**CR20** 是一个**动量因子**（Momentum Factor），用于衡量股票价格的相对强弱趋势。

- **数据库字段**: `cr_qfq` (前复权的CR20值)
- **数据来源**: `stk_factor_pro` 表
- **因子类型**: 动量/趋势因子

---

## 🔢 CR20计算公式

### 1. 基础定义

CR20 = **20日动量指标**，计算公式为：

```
CR20 = (当日收盘价 - 20日前收盘价) / 20日前收盘价 × 100
```

或者更复杂的加权计算（不同平台可能有差异）：

```
CR20 = Σ(每日涨跌幅 × 权重) / Σ权重
```

### 2. 在策略中的使用

#### 数据获取
```python
# 从数据库获取CR20数据
sql = """
SELECT ts_code, trade_date, cr_qfq
FROM stk_factor_pro
WHERE trade_date >= %s AND trade_date <= %s
  AND ts_code IN (...)
ORDER BY ts_code, trade_date
"""

# 转换为透视表格式
cr_pivot = cr_df.pivot(index='trade_date', columns='ts_code', values='cr_qfq')
```

#### 筛选指标计算

**① 长期趋势 (30日平均)**
```python
long_term = cr_pivot.tail(30).mean()
# 计算最近30天的CR20平均值，反映中期趋势
```

**② 短期趋势 (10日平均)**
```python
short_term = cr_pivot.tail(10).mean()
# 计算最近10天的CR20平均值，反映近期趋势
```

**③ 增长率**
```python
cr_growth = (short_term - long_term) / long_term * 100
# 短期趋势相对于长期趋势的增长百分比
```

**④ 波动率**
```python
recent_window = cr_pivot.tail(5)
recent_volatility = recent_window.std() / recent_window.mean() * 100
# 最近5天CR20的波动率（标准差/均值）
```

**⑤ 趋势验证**
```python
recent_cr20 = cr_pivot[stock].dropna().tail(5)
increase_days = sum(recent_cr20.iloc[i] > recent_cr20.iloc[i-1] for i in range(1, 5))
overall_up = recent_cr20.iloc[-1] > recent_cr20.iloc[0]
# 检查最近5天是否有3天上涨，且整体趋势向上
```

---

## 🎯 CR20筛选条件详解

### 1. 有效数据要求
```python
valid_days = cr_pivot.count()
valid_mask = valid_days >= 10
```
- 要求至少有10天的CR20数据
- 确保数据完整性

### 2. 范围要求
```python
core_mask = (short_term > 60) & (short_term < 140)
buffer_mask = (short_term > 54) & (short_term < 154)
range_mask = core_mask | (buffer_mask & (cr_growth > 12))
```

**核心区间**: 60-140
- **60以下**: 弱势区域，不考虑
- **60-140**: 理想区间，直接通过
- **140以上**: 过热区域，不考虑

**缓冲区间**: 54-154 (带条件通过)
- 如果在54-60或140-154之间
- 且增长率 > 12%，也可以通过

### 3. 增长要求
```python
core_growth_mask = cr_growth >= 10
```
- CR20短期均值相比长期均值增长至少10%
- 确保股票处于上升趋势中

### 4. 稳定性要求
```python
is_stable = recent_volatility < 18
```
- 最近5天CR20波动率 < 18%
- 避免过度波动的股票

### 5. 趋势要求
```python
trend_mask = (increase_days >= 3) & overall_up
```
- 最近5天至少有3天上涨
- 第5天价格 > 第1天价格
- 确保趋势持续性

---

## 📈 CR20值的含义

### 典型值解读

| CR20值 | 含义 | 状态 |
|--------|------|------|
| < 60 | 弱势下跌 | ❌ 淘汰 |
| 60-80 | 底部企稳 | ⚠️ 需观察 |
| 80-120 | 正常波动 | ✅ 可接受 |
| 120-140 | 强势上涨 | ✅ 优选 |
| > 140 | 过热 | ❌ 淘汰 |

### 示例计算

假设某股票CR20数据如下（最近10天）：
```
日期:  1   2   3   4   5   6   7   8   9   10
CR20: 85  88  92  95  98  102 105 108 112 115
```

**计算过程**:
```python
long_term = 10天平均 = (85+88+92+95+98+102+105+108+112+115)/10 = 100.0
short_term = 最近3天平均 = (108+112+115)/3 = 111.7
cr_growth = (111.7 - 100.0) / 100.0 * 100 = 11.7%

# 波动率
std = 10.1, mean = 100.0
volatility = 10.1/100.0 * 100 = 10.1%

# 趋势
increase_days = 5天 (6→7, 7→8, 8→9, 9→10, 10>6) = 4天
overall_up = 115 > 85 = True

# 结果
范围: 111.7 ∈ (60,140) ✓
增长: 11.7% >= 10% ✓
波动: 10.1% < 18% ✓
趋势: 4天 >= 3天 且整体向上 ✓
```
**结论**: 通过筛选 ✅

---

## 🆚 CR20 vs 其他动量指标

| 指标 | 计算方式 | 优点 | 缺点 |
|------|----------|------|------|
| **CR20** | 20日动量加权 | 平滑且有趋势性 | 滞后性 |
| **RSI** | 相对强弱指标 | 反转信号敏感 | 震荡市假信号多 |
| **MACD** | 双均线差值 | 趋势确认好 | 滞后严重 |
| **MA均线** | 简单移动平均 | 直观易懂 | 对短期波动不敏感 |

---

## 💡 CR20在策略中的作用

### 1. 筛选强势股
- CR20在60-140区间 = 股票处于上升通道
- 增长率 > 10% = 动量持续增强

### 2. 排除弱势股
- CR20 < 60 = 下跌趋势
- CR20 > 140 = 可能过热回调

### 3. 确认趋势持续性
- 3天连续上涨 + 整体向上 = 趋势确认
- 波动率 < 18% = 趋势稳定

### 4. 结合其他因子
```
换手率筛选 → 价格流动性 → PEG估值 → CR20动量
```
CR20作为最后一道筛选，确保选出的股票：
- 估值合理 (PEG)
- 流动性好 (换手率)
- **趋势向上 (CR20)** ← 最终确认

---

## 📊 实际案例分析

### 案例1: 002276.SZ (电力设备)
```
CR20数据: 114.8
增长率: 43.8%
波动率: 低
趋势: 连续上涨
```
**分析**:
- CR20 = 114.8 ∈ (60,140) ✓
- 增长43.8% >> 10% ✓
- 强势股票，入选 ✅

### 案例2: 002530.SZ (计算机)
```
CR20数据: 90.8
增长率: 35.4%
波动率: 低
趋势: 稳步上涨
```
**分析**:
- CR20 = 90.8 ∈ (60,140) ✓
- 增长35.4% >> 10% ✓
- 虽然CR20不高，但增长快，入选 ✅

### 案例3: 被淘汰的股票
```
CR20数据: 55
增长率: 5%
```
**分析**:
- CR20 = 55 < 60 ❌
- 即使增长，但基础太弱，淘汰 ❌

---

## 🔍 数据来源说明

### stk_factor_pro 表结构
```sql
CREATE TABLE stk_factor_pro (
    ts_code VARCHAR(20),      -- 股票代码
    trade_date VARCHAR(8),    -- 交易日期
    cr_qfq DECIMAL(10,4),     -- CR20前复权值
    alpha_038 DECIMAL(10,4),  -- 其他因子...
    alpha_120cq DECIMAL(10,4),
    alpha_pluse DECIMAL(10,4),
    PRIMARY KEY (ts_code, trade_date)
);
```

### 数据预处理
CR20值在入库前已经过：
1. **前复权处理** - 消除分红除权影响
2. **异常值处理** - 剔除极端值
3. **标准化** - 便于跨股票比较

---

## ⚠️ 注意事项

### 1. 数据质量
- 确保CR20数据完整（至少10天）
- 缺失数据会自动剔除

### 2. 滞后性
- CR20基于历史数据计算
- 无法预测突发事件

### 3. 适用场景
- ✅ 趋势跟踪策略
- ✅ 动量因子选股
- ❌ 反转策略
- ❌ 震荡行情

### 4. 参数敏感性
- 30日/10日周期可根据市场调整
- 18%波动率阈值是经验值

---

## 📝 总结

CR20是一个**复合动量指标**，通过以下维度评估股票趋势：

1. **趋势强度**: 长期 vs 短期均值
2. **趋势方向**: 增长率正负
3. **趋势稳定性**: 波动率控制
4. **趋势持续性**: 连续上涨验证

在策略中，CR20确保选出的股票：
- ✅ 处于上升通道
- ✅ 动量持续增强
- ✅ 趋势稳定可控
- ✅ 避免追高买入

---

**相关文件**:
- 主策略: `聚宽策略V3_数据库版.py` (第941-1077行)
- 测试脚本: `test_统一标准.py` (第218-300行)
- 配置: `core/config/settings.py` (第148-152行)

**生成时间**: 2026-01-04
