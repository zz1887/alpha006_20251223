# 聚宽策略V3 - 数据库适配版 使用说明

## 📋 概述

本策略是将原聚宽平台的选股策略V3适配到MySQL数据库环境，保持原有筛选逻辑不变，仅替换数据获取方式。

### 核心变化
- **数据源**: 聚宽API → MySQL数据库
- **字段映射**: 聚宽字段名 → 数据库字段名
- **股票代码**: `000001.XSHE` → `000001.SZ`

---

## 📁 文件结构

```
strategies/runners/
├── 聚宽策略V3_数据库版.py      # 核心策略文件（适配数据库）
├── strategy_executor.py        # 策略执行器
└── README_数据库版说明.md      # 本说明文档
```

---

## 🔧 数据库配置

### 连接配置
数据库配置位于 `core/config/settings.py`:

```python
DATABASE_CONFIG = {
    'host': '172.31.112.1',    # WSL2连接Windows主机IP
    'port': 3306,
    'user': 'root',
    'password': '12345678',
    'database': 'stock_database',
    'charset': 'utf8mb4',
}
```

### 核心数据表
| 表名 | 用途 | 关键字段 |
|------|------|----------|
| `daily_kline` | 日线行情（已前复权） | `close`, `vol`, `high`, `low` |
| `daily_basic` | 日度基本面 | `turnover_rate_f`, `pe_ttm` |
| `stk_factor_pro` | 技术指标因子 | `cr_qfq`, `ma_qfq_*` |
| `sw_industry` | 申万行业分类 | `l1_name` |
| `stock_st` | ST股票状态 | `type` |
| `new_share` | 新股信息 | `issue_date` |
| `fina_indicator` | 财务指标 | `dt_netprofit_yoy` |
| `index_daily_zzsz` | 指数数据 | `close` |

---

## 🚀 使用方法

### 1. 检查数据库连接

```bash
cd /home/zcy/alpha006_20251223/strategies/runners
python strategy_executor.py --mode dbcheck
```

输出示例：
```
==================== 数据库连接检查 ====================
✅ 数据库连接正常
  daily_kline: 连接正常
  daily_basic: 连接正常
  stk_factor_pro: 连接正常
  sw_industry: 连接正常

最近交易日期: 20250103
```

### 2. 单日测试

测试指定日期的选股结果：

```bash
# 测试最近交易日
python strategy_executor.py --mode test

# 测试指定日期
python strategy_executor.py --mode test --date 2025-01-03
```

输出示例：
```
==================== 单日测试: 2025-01-03 ====================
策略初始化完成：每月6日调仓，最大持仓5只
止损比例: 10.0%，止盈比例: 60.0%

【2025-01-03】执行调仓...
==================== 开始筛选流程（初始股票数：1200） =====
[主处理] 换手率筛选：使用40.0%分位数阈值(2.45)，保留 480 只股票
[主处理] 价格流动性筛选：保留 356 只股票
[主处理] PEG因子筛选：保留 128 只股票
[主处理] CR20因子筛选完成：共保留 45 只（创业板 12 只，非创业板 33 只）
[单股票筛选进度：45/45，已合格：8只
===== 筛选流程结束 =====
初始股票数：1200 → 主处理后：45 → 最终合格：8
总耗时：12.34秒

【调仓总结】耗时12.56秒，最终持仓8只
```

### 3. 回测运行

运行指定日期范围的回测：

```bash
# 回测2024年12月到2025年1月
python strategy_executor.py --mode backtest --start 2024-12-01 --end 2025-01-31 --rebalance 6
```

参数说明：
- `--start`: 回测开始日期
- `--end`: 回测结束日期
- `--rebalance`: 调仓日（每月几号，默认6）

### 4. 因子分析

分析单只股票的因子数据：

```bash
python strategy_executor.py --mode factor --date 2025-01-03 --stock 300001.SZ
```

输出示例：
```
==================== 因子分析: 300001.SZ @ 2025-01-03 ====================

1. 获取股票池...
   创业板股票: 520只

2. 300001.SZ 在股票池中 ✓

3. 获取价格数据...
   数据长度: 120天
   最近5日收盘价: [12.34, 12.56, 12.45, 12.68, 12.75]

4. 获取换手率数据...
   数据长度: 120天
   最近5日换手率: [2.34, 3.45, 2.89, 4.12, 3.56]

5. 获取因子数据...
   PEG数据: 45天
   最近PEG: [1.23, 1.25, 1.28, 1.30, 1.32]
   CR20数据: 45天
   最近CR20: [85.3, 87.2, 89.5, 92.1, 94.8]
```

---

## 📊 策略参数

### 核心参数（可在策略文件中修改）

```python
g.params = {
    # 价格/换手率/因子等核心筛选参数
    'price_period': 120,                # 价格分析周期（天）
    'turnover_period': 30,              # 换手率周期（天）
    'cr20_long_period': 30,             # CR20长期周期
    'turnover_quantile': 0.4,           # 换手率分位数阈值（40%）
    'pulse_days': 40,                   # 脉冲检测周期（天）
    'min_turnover': 3,                  # 最低换手率阈值（%）

    # 止损止盈参数
    'stop_loss_ratio': 0.10,            # 止损比例（10%）
    'take_profit_ratio': 0.60,          # 止盈比例（60%）
    'max_portfolio_drawdown': 15,       # 最大回撤（15%）

    # 流动性参数
    'min_avg_volume': 5000,             # 最低平均成交量（手）
    'min_valid_days': 15,               # 最低有效数据天数

    # 交易参数
    'max_position': 5,                  # 最大持仓数量
    'transaction_cost_rate': 0.0015,    # 佣金率（0.15%）
    'min_commission': 5,                # 最低佣金（5元）

    # 价格相关参数
    'price_quantile_threshold': 0.3,    # 价格低位分位数阈值（30%）
    'max_recent_drop': 30,              # 最大近期跌幅（30%）

    # PEG因子参数
    'default_peg_threshold': 2.0,       # 默认PEG阈值

    # CR20因子参数
    'cr20_short_period': 10,            # 短期周期（天）
    'cr20_low_threshold': 60,           # 低位阈值
    'cr20_high_threshold': 140,         # 高位阈值
    'cr20_increase_threshold': 10,      # 增长阈值（%）
    'cr20_stable_days': 5,              # 稳定性检查周期（天）

    # 均线参数
    'ma_periods': [10, 20, 60, 120],    # 均线周期
    'ma_spread_threshold': 10,          # 均线最大发散度（%）
    'ma_trend_period': 40,              # 均线趋势对比周期（天）

    # 系统参数
    'debug': True,                      # 调试模式
    'rebalance_monthday': 6,            # 调仓日（每月6号）
    'merge_tolerance': 0.6,             # 数据合并容忍度
    'pass_score': 5,                    # 合格分数线
}
```

---

## 🔍 筛选流程

### 第一阶段：主处理模块（批量粗筛）

1. **换手率筛选**
   - 使用市场分位数阈值（默认40%）
   - 过滤数据不足的股票

2. **价格流动性筛选**
   - 检查成交量（最低5000手）
   - 检查近期跌幅（不超过30%）

3. **PEG因子筛选**
   - 按行业动态调整阈值（1.1-3.0）
   - 过滤高估值股票

4. **CR20因子筛选**
   - 适配创业板特性（更宽松）
   - 检查趋势、波动率、增长

### 第二阶段：单股票详细筛选

1. **换手率脉冲**：识别放量信号
2. **价格低位**：判断是否处于低位
3. **均线趋势**：多周期均线分析
4. **跑赢指数**：相对强弱分析

### 评分系统
- 基础分：2分（通过主处理）
- 脉冲：0-2分
- 价格低位：+1分
- 均线趋势：0-2分
- 跑赢指数：+1分
- **合格线**：5分

---

## 📈 输出说明

### 调仓日输出
```
【2025-01-06】开始月度调仓
===== 开始筛选流程（初始股票数：1200） =====
[主处理] 换手率筛选：保留 480 只股票
[主处理] 价格流动性筛选：保留 356 只股票
[主处理] PEG因子筛选：保留 128 只股票
[主处理] CR20因子筛选完成：共保留 45 只
[单股票筛选进度：45/45，已合格：8只

【调仓总结】耗时12.56秒，最终持仓8只
```

### 每日监控输出
```
【市场监控】2025-01-07（上次调仓日：2025-01-06）
  沪深300(000300.SH)：3856.32元，涨跌幅+0.52%
  上证指数(000001.SH)：3156.23元，涨跌幅+0.31%

【持仓详情】共8只股票
  代码         数量(股)    成本价    当前价    盈亏(%)
  300001.SZ    1000        12.34     12.75     +3.32%
  300002.SZ    800         23.45     24.12     +2.86%
  ...

【资产概况】总资产: 1000000.00元, 现金占比: 15.23%
```

---

## ⚠️ 注意事项

### 1. 数据日期格式
- 数据库使用：`YYYYMMDD`（如：20250103）
- Python内部统一转换为：`datetime` 对象
- 输出显示：`YYYY-MM-DD`（如：2025-01-03）

### 2. 股票代码格式
- 数据库：`000001.SZ`, `600000.SH`
- 注意：创业板以`.SZ`结尾，主板以`.SH`或`.SZ`结尾

### 3. 前复权处理
- `daily_kline.close` 已经是前复权价格
- 策略直接使用 `close` 字段，无需额外复权

### 4. 性能优化
- 使用缓存机制（1小时过期）
- 批量查询（每批100-200只股票）
- 并行处理（4线程）

### 5. 错误处理
- 数据库连接失败会自动重试（3次）
- 数据缺失会自动跳过
- 筛选结果过少会自动放宽条件

---

## 🐛 常见问题

### Q1: 数据库连接失败
**检查步骤**：
1. 确认MySQL服务正在运行
2. 检查WSL2网络配置（172.31.112.1）
3. 验证用户名密码
4. 运行 `python strategy_executor.py --mode dbcheck`

### Q2: 筛选结果为空
**可能原因**：
- 日期不是交易日
- 股票池过滤过严
- 数据缺失

**解决方法**：
- 检查日期是否为交易日
- 调整 `turnover_quantile` 参数
- 查看日志中的详细筛选过程

### Q3: 运行速度慢
**优化建议**：
- 启用缓存：`DataLoader(use_cache=True)`
- 减少调试日志：`debug=False`
- 调小批次大小

---

## 📞 技术支持

如有问题，请检查：
1. 数据库连接状态
2. 数据表是否存在
3. 数据是否完整
4. 日志输出信息

---

## 🔄 版本历史

- **v1.0** (2026-01-04): 初始数据库适配版本
  - 替换聚宽API为SQL查询
  - 适配数据库字段映射
  - 保持原有筛选逻辑不变
  - 添加缓存和性能优化

---

## 📝 示例代码

### 自定义运行

```python
from strategies.runners.聚宽策略V3_数据库版 import (
    initialize, select_and_adjust, Context
)
from datetime import datetime

# 创建上下文
test_date = datetime(2025, 1, 6)
context = Context(test_date)

# 初始化
initialize(context)

# 执行调仓
select_and_adjust(context)
```

### 批量测试

```python
from strategies.runners.strategy_executor import run_backtest

# 回测2024年全年
run_backtest('2024-01-01', '2024-12-31', rebalance_day=6)
```

---

**文档版本**: v1.0
**最后更新**: 2026-01-04
