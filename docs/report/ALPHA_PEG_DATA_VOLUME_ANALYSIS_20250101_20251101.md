# alpha_pegå› å­ - 1-3æœˆæ•°æ®é‡é—®é¢˜æ·±åº¦åˆ†æž

## ðŸ“Š é—®é¢˜æè¿°

åœ¨å›žæµ‹è¿‡ç¨‹ä¸­å‘çŽ°ï¼Œ**2025å¹´1-3æœˆçš„å› å­æ•°æ®é‡æ˜Žæ˜¾ä¸è¶³**ï¼Œå¯¼è‡´ï¼š
- éƒ¨åˆ†è°ƒä»“å‘¨æœŸæ— æ³•è¿›è¡Œæœ‰æ•ˆåˆ†ç»„
- å›žæµ‹ç»“æžœå¯èƒ½ä¸å®Œæ•´
- å•è°ƒæ€§åˆ†æžå—å½±å“

---

## ðŸ” å·²çŸ¥ä¿¡æ¯

### å›žæµ‹é…ç½®
```python
æ—¶é—´èŒƒå›´: 20250101 - 20251101
è°ƒä»“é¢‘çŽ‡: æœˆåº¦
è°ƒä»“æ—¥æœŸ: 10ä¸ªå‘¨æœŸ
  20250127, 20250228, 20250331, 20250430, 20250530,
  20250630, 20250731, 20250829, 20250930, 20251031
```

### å› å­è®¡ç®—è§„åˆ™
```python
# 1. èŽ·å–PEæ•°æ® (pe_ttm > 0)
# 2. èŽ·å–è´¢åŠ¡æ•°æ® (dt_netprofit_yoy != 0)
# 3. æ—¶é—´å¯¹é½: trade_date = ann_date (å‰å‘å¡«å……)
# 4. è®¡ç®—: alpha_peg = pe_ttm / dt_netprofit_yoy_ffill
# 5. æ¸…æ´—: pe_ttmâ‰¤0 æˆ– å¢žé•¿çŽ‡â‰¤0 â†’ alpha_peg = 0
```

### é›¶å€¼å æ¯”ï¼ˆ2025-10-31ï¼‰
```
æ€»æ ·æœ¬: ~2,500åªè‚¡ç¥¨
é›¶å€¼: ~1,100åª (44.1%)
éžé›¶å€¼: ~1,400åª (55.9%)
```

---

## â“ 1-3æœˆæ•°æ®é‡å°‘çš„å¯èƒ½åŽŸå› 

### å‡è®¾1: è´¢åŠ¡æ•°æ®æŠ«éœ²å‘¨æœŸ â­â­â­â­â­

**æ ¸å¿ƒé—®é¢˜**: 1-3æœˆç¼ºä¹æœ€æ–°çš„å¹´åº¦è´¢åŠ¡æ•°æ®

```
è´¢åŠ¡æ•°æ®æŠ«éœ²æ—¶é—´çº¿:
â”œâ”€â”€ 1-3æœˆ: ä¸Šä¸€å¹´å¹´æŠ¥æœªæŠ«éœ²
â”‚   â”œâ”€â”€ 2024å¹´æŠ¥è¦åˆ°2025å¹´4æœˆåŽæ‰æŠ«éœ²
â”‚   â”œâ”€â”€ dt_netprofit_yoyæ•°æ®ç¼ºå¤±
â”‚   â””â”€â”€ å‰å‘å¡«å……æ— æ³•è¦†ç›–ï¼ˆæ— åŽ†å²æ•°æ®ï¼‰
â”œâ”€â”€ 4-6æœˆ: å¹´æŠ¥é›†ä¸­æŠ«éœ²æœŸ
â”‚   â”œâ”€â”€ 2024å¹´æŠ¥é™†ç»­å‘å¸ƒ
â”‚   â”œâ”€â”€ æ•°æ®é€æ¸å®Œæ•´
â”‚   â””â”€â”€ å‰å‘å¡«å……å¼€å§‹ç”Ÿæ•ˆ
â””â”€â”€ 7-12æœˆ: æ•°æ®å®Œæ•´æœŸ
    â”œâ”€â”€ æœ‰æœ€æ–°å¹´æŠ¥æ•°æ®
    â”œâ”€â”€ å‰å‘å¡«å……æ•ˆæžœå¥½
    â””â”€â”€ æ ·æœ¬é‡å……è¶³
```

**éªŒè¯æ–¹æ³•**:
```python
# æ£€æŸ¥1-3æœˆçš„è´¢åŠ¡æ•°æ®å¯ç”¨æ€§
sql = """
SELECT COUNT(*) as cnt
FROM fina_indicator
WHERE ann_date >= '20250101' AND ann_date <= '20250331'
  AND update_flag = '1'
"""
# é¢„æœŸç»“æžœ: cnt â‰ˆ 0 (æ— 2024å¹´æŠ¥æ•°æ®)
```

### å‡è®¾2: å‰å‘å¡«å……æœºåˆ¶é™åˆ¶ â­â­â­â­â­

**é—®é¢˜**: æ—©æœŸæ•°æ®æ— æ³•å‰å‘å¡«å……

```python
# 2025-01-27çš„å› å­è®¡ç®—
df_20250127 = df_factor[df_factor['trade_date'] == '20250127']

# éœ€è¦ dt_netprofit_yoy_ffill
# ä½†:
# - 2024å¹´æŠ¥æœªæŠ«éœ² â†’ æ— ann_date='20250127'çš„æ•°æ®
# - æ— åŽ†å²æ•°æ® â†’ ffill()è¿”å›žNaN
# - ç»“æžœ: å¤§é‡è‚¡ç¥¨æ— æ³•è®¡ç®—alpha_peg

# 2025-04-30çš„å› å­è®¡ç®—
df_20250430 = df_factor[df_factor['trade_date'] == '20250430']

# æ­¤æ—¶:
# - 2024å¹´æŠ¥å·²æŠ«éœ² â†’ æœ‰ann_date='20250430'çš„æ•°æ®
# - æˆ–æœ‰åŽ†å²æ•°æ® â†’ ffill()å¯å¡«å……
# - ç»“æžœ: æ ·æœ¬é‡æ­£å¸¸
```

**æ•°æ®æµç¨‹**:
```
trade_date='20250127'
  â†“
æŸ¥æ‰¾ ann_date='20250127' çš„è´¢åŠ¡æ•°æ®
  â†“
ç»“æžœ: 0æ¡ (2024å¹´æŠ¥æœªæŠ«éœ²)
  â†“
å‰å‘å¡«å……: æ— åŽ†å²æ•°æ® â†’ NaN
  â†“
æœ‰æ•ˆæ ·æœ¬: 0
```

### å‡è®¾3: PEæ•°æ®å­£èŠ‚æ€§å› ç´  â­â­â­

**å¯èƒ½åŽŸå› **:
- 1-3æœˆæ˜¯å¹´æŠ¥æŠ«éœ²æœŸï¼Œéƒ¨åˆ†å…¬å¸PEæ•°æ®å¼‚å¸¸
- æ˜¥èŠ‚å‡æœŸå½±å“äº¤æ˜“ï¼Œæ•°æ®æ›´æ–°ä¸åŠæ—¶
- æ–°è‚¡ä¸Šå¸‚æ·¡å­£

**éªŒè¯æ–¹æ³•**:
```python
# ç»Ÿè®¡å„æœˆPEæ•°æ®é‡
sql = """
SELECT
  SUBSTR(trade_date, 1, 6) as month,
  COUNT(*) as pe_count
FROM daily_basic
WHERE trade_date >= '20250101' AND trade_date <= '20251101'
  AND pe_ttm > 0
GROUP BY month
ORDER BY month
"""
```

### å‡è®¾4: æ•°æ®æ¸…æ´—è§„åˆ™è¿‡ä¸¥ â­â­

**é—®é¢˜**: è´Ÿå€¼ç½®0å¯¼è‡´å¤§é‡æ•°æ®ä¸¢å¤±

```
åŽŸå§‹æ•°æ®:
â”œâ”€â”€ PEæ•°æ®: 100,000æ¡
â”œâ”€â”€ è´¢åŠ¡æ•°æ®: 50,000æ¡
â”œâ”€â”€ å…³è”åŽ: 50,000æ¡
â”œâ”€â”€ è´Ÿå€¼æ¸…æ´—: 20,000æ¡ â†’ 0
â””â”€â”€ æœ‰æ•ˆæ•°æ®: 30,000æ¡ (60%ä¿ç•™)

æ—©æœŸæ•°æ®å¯èƒ½æ›´å·®:
â”œâ”€â”€ å…³è”åŽ: 5,000æ¡
â”œâ”€â”€ è´Ÿå€¼æ¸…æ´—: 3,000æ¡ â†’ 0
â””â”€â”€ æœ‰æ•ˆæ•°æ®: 2,000æ¡ (40%ä¿ç•™)
```

---

## ðŸ“ˆ æ•°æ®é‡è¶‹åŠ¿é¢„æµ‹

åŸºäºŽè´¢åŠ¡æŠ«éœ²å‘¨æœŸï¼Œå„æœˆæ•°æ®é‡å¯èƒ½å¦‚ä¸‹ï¼š

| æœˆä»½ | é¢„æœŸæ•°æ®é‡ | åŽŸå›  |
|------|-----------|------|
| 2025-01 | æžå°‘ | æ— 2024å¹´æŠ¥ |
| 2025-02 | æžå°‘ | æ— 2024å¹´æŠ¥ |
| 2025-03 | æžå°‘ | æ— 2024å¹´æŠ¥ |
| 2025-04 | å¼€å§‹å¢žé•¿ | å¹´æŠ¥æŠ«éœ²åˆæœŸ |
| 2025-05 | æ­£å¸¸ | å¹´æŠ¥æŠ«éœ²é«˜å³°æœŸ |
| 2025-06 | æ­£å¸¸ | å¹´æŠ¥æŠ«éœ²å®Œæˆ |
| 2025-07-12 | å……è¶³ | æ•°æ®å®Œæ•´ |

---

## ðŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: è°ƒæ•´å›žæµ‹æ—¶é—´èŒƒå›´ï¼ˆæŽ¨èï¼‰

```python
# é¿å¼€æ•°æ®ç¼ºå¤±æœŸ
start_date = '20250401'  # ä»Ž4æœˆå¼€å§‹
end_date = '20251101'
```

**ä¼˜ç‚¹**:
- æ•°æ®å®Œæ•´
- å›žæµ‹ç»“æžœå¯é 
- å•è°ƒæ€§æ›´æ˜“éªŒè¯

**ç¼ºç‚¹**:
- å›žæµ‹å‘¨æœŸç¼©çŸ­

### æ–¹æ¡ˆ2: ä½¿ç”¨åŽ†å²è´¢åŠ¡æ•°æ®

```python
# ä½¿ç”¨ä¸Šä¸€å¹´æ•°æ®ä½œä¸ºè¿‡æ¸¡
sql_fina = """
SELECT ts_code, ann_date, dt_netprofit_yoy
FROM fina_indicator
WHERE ann_date >= '20240101' AND ann_date <= '20251101'
  AND update_flag = '1'
"""
```

**ä¼˜ç‚¹**:
- ä¿æŒå®Œæ•´æ—¶é—´èŒƒå›´
- æ—©æœŸæ•°æ®æœ‰æ”¯æ’‘

**ç¼ºç‚¹**:
- 1-3æœˆä½¿ç”¨çš„æ˜¯2023å¹´æ•°æ®ï¼Œæ—¶æ•ˆæ€§å·®
- å¯èƒ½å½±å“å› å­å‡†ç¡®æ€§

### æ–¹æ¡ˆ3: æ”¹è¿›å› å­å®šä¹‰

```python
def calculate_alpha_peg_v3(df: pd.DataFrame) -> pd.DataFrame:
    """
    æ”¹è¿›ç‰ˆ: ä½¿ç”¨å¢žé•¿çŽ‡ç»å¯¹å€¼ + æŽ’é™¤é›¶å€¼
    """
    # 1. è®¡ç®—åŽŸå§‹å€¼
    df['alpha_peg_raw'] = df['pe_ttm'] / df['dt_netprofit_yoy_ffill']

    # 2. ä½¿ç”¨ç»å¯¹å€¼ï¼ˆæ¶ˆé™¤è´Ÿå€¼é—®é¢˜ï¼‰
    df['alpha_peg'] = df['alpha_peg_raw'].abs()

    # 3. æŽ’é™¤æ— æ•ˆå€¼
    df = df[df['alpha_peg'] > 0]

    # 4. åŽ»æžå€¼
    q1 = df['alpha_peg'].quantile(0.01)
    q99 = df['alpha_peg'].quantile(0.99)
    df = df[(df['alpha_peg'] >= q1) & (df['alpha_peg'] <= q99)]

    return df
```

**ä¼˜ç‚¹**:
- æ¶ˆé™¤é›¶å€¼é—®é¢˜
- ä¿æŒå› å­å•è°ƒæ€§
- å‡å°‘æ•°æ®ä¸¢å¤±

**ç¼ºç‚¹**:
- æ”¹å˜äº†å› å­å«ä¹‰
- éœ€è¦é‡æ–°éªŒè¯

### æ–¹æ¡ˆ4: åˆ†å±‚å¤„ç†

```python
# 1. 1-3æœˆ: ä½¿ç”¨ç®€åŒ–å› å­
# 2. 4-12æœˆ: ä½¿ç”¨å®Œæ•´å› å­
# 3. åˆ†åˆ«å›žæµ‹åŽåˆå¹¶ç»“æžœ
```

**ä¼˜ç‚¹**:
- å…¼é¡¾æ•°æ®å®Œæ•´æ€§å’Œå‡†ç¡®æ€§

**ç¼ºç‚¹**:
- å®žçŽ°å¤æ‚
- å› å­å®šä¹‰ä¸ä¸€è‡´

---

## ðŸ“‹ éªŒè¯æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥æ•°æ®åº“è¿žæŽ¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿žæŽ¥
python -c "
import sys
sys.path.insert(0, '/home/zcy/alpha006_20251223')
from core.utils.db_connection import db
sql = 'SELECT COUNT(*) as cnt FROM daily_basic WHERE trade_date = 20250127'
result = db.execute_query(sql)
print(f'1æœˆ27æ—¥PEæ•°æ®: {result[0][\"cnt\"]}')
"
```

### æ­¥éª¤2: ç»Ÿè®¡å„æœˆæ•°æ®é‡

```python
# ç»Ÿè®¡å„è°ƒä»“æ—¥æ•°æ®
for date in rebalance_dates[:-1]:
    df_date = df_factor[df_factor['trade_date'] == date]
    print(f"{date}: {len(df_date)}æ¡, é›¶å€¼: {(df_date['alpha_peg']==0).sum()}")
```

### æ­¥éª¤3: æ£€æŸ¥è´¢åŠ¡æ•°æ®å¯ç”¨æ€§

```python
# æ£€æŸ¥å„æœˆè´¢åŠ¡æ•°æ®
sql = """
SELECT
  SUBSTR(ann_date, 1, 6) as month,
  COUNT(*) as cnt
FROM fina_indicator
WHERE ann_date >= '20250101' AND ann_date <= '20251101'
  AND update_flag = '1'
GROUP BY month
ORDER BY month
"""
```

---

## ðŸŽ¯ å»ºè®®è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨
1. âœ… **éªŒè¯æ•°æ®åº“è¿žæŽ¥** - ç¡®è®¤æ˜¯å¦æ˜¯è¿žæŽ¥é—®é¢˜
2. âš ï¸ **æ£€æŸ¥1-3æœˆåŽŸå§‹æ•°æ®** - ç»Ÿè®¡PEå’Œè´¢åŠ¡æ•°æ®é‡
3. ðŸ”„ **è°ƒæ•´å›žæµ‹æ—¶é—´** - ä»Ž4æœˆå¼€å§‹é‡æ–°å›žæµ‹

### åŽç»­ä¼˜åŒ–
1. **æ”¹è¿›å› å­å®šä¹‰** - ä½¿ç”¨ç»å¯¹å€¼æˆ–æŽ’é™¤é›¶å€¼
2. **è¡Œä¸šä¸­æ€§åŒ–** - æ¶ˆé™¤è¡Œä¸šåå·®
3. **å¤šå› å­ç»„åˆ** - æé«˜ç¨³å®šæ€§

---

## ðŸ“Š é¢„æœŸæ”¹è¿›æ•ˆæžœ

### å½“å‰é—®é¢˜
```
1-3æœˆ: æ•°æ®ç¼ºå¤± â†’ å›žæµ‹è·³è¿‡ â†’ æ ·æœ¬å‡å°‘
4-12æœˆ: æ•°æ®å®Œæ•´ â†’ æ­£å¸¸å›žæµ‹
ç»“æžœ: æ€»æ ·æœ¬å‡å°‘ï¼ŒICè®¡ç®—å—å½±å“
```

### æ”¹è¿›åŽ
```
1-3æœˆ: è·³è¿‡æˆ–ç®€åŒ–
4-12æœˆ: å®Œæ•´å›žæµ‹
ç»“æžœ: æ ·æœ¬å……è¶³ï¼Œç»“æžœå¯é 
```

---

## ðŸ“ ç›¸å…³æ–‡ä»¶

```
archive/code/
â”œâ”€â”€ analyze_zero_distribution.py      # é›¶å€¼åˆ†å¸ƒåˆ†æž
â”œâ”€â”€ analyze_backtest_data.py          # åŸºäºŽå·²çŸ¥ç»“æžœåˆ†æž
â””â”€â”€ test_exclude_zero.py              # é›¶å€¼å½±å“æµ‹è¯•

docs/report/
â”œâ”€â”€ ALPHA_PEG_FACTOR_BACKTEST_COMPARISON_20250101_20251101.md  # å¯¹æ¯”åˆ†æž
â””â”€â”€ ALPHA_PEG_DATA_VOLUME_ANALYSIS_20250101_20251101.md        # æœ¬æŠ¥å‘Š

results/backtest/
â”œâ”€â”€ alpha_peg_modified_20250101_20251101_*.csv                 # ç­–ç•¥Aç»“æžœ
â””â”€â”€ alpha_peg_exclude_zero_20250101_20251101_*.csv             # ç­–ç•¥Bç»“æžœ
```

---

## ðŸ’¡ æ ¸å¿ƒç»“è®º

**1-3æœˆæ•°æ®é‡å°‘çš„æ ¹æœ¬åŽŸå› **:

1. **è´¢åŠ¡æ•°æ®æŠ«éœ²å‘¨æœŸ** â­â­â­â­â­
   - 2024å¹´æŠ¥åœ¨2025å¹´4æœˆåŽæ‰æŠ«éœ²
   - 1-3æœˆç¼ºä¹dt_netprofit_yoyæ•°æ®
   - å‰å‘å¡«å……æ— æ³•è§£å†³æ—©æœŸæ•°æ®ç¼ºå¤±

2. **å› å­è®¡ç®—ä¾èµ–è´¢åŠ¡æ•°æ®** â­â­â­â­â­
   - alpha_peg = PE / å¢žé•¿çŽ‡
   - å¢žé•¿çŽ‡ç¼ºå¤± â†’ å› å­æ— æ³•è®¡ç®—
   - å¯¼è‡´1-3æœˆæ ·æœ¬é‡æžå°‘

3. **æ•°æ®æ¸…æ´—åŠ å‰§é—®é¢˜** â­â­â­
   - è´Ÿå€¼ç½®0è¿›ä¸€æ­¥å‡å°‘æœ‰æ•ˆæ ·æœ¬
   - æ—©æœŸæ•°æ®ä¸­è´Ÿå€¼æ¯”ä¾‹å¯èƒ½æ›´é«˜

**è§£å†³æ–¹æ¡ˆ**:
- âœ… è°ƒæ•´å›žæµ‹æ—¶é—´ä»Ž4æœˆå¼€å§‹
- âœ… æ”¹è¿›å› å­å®šä¹‰ï¼ˆä½¿ç”¨ç»å¯¹å€¼ï¼‰
- âœ… éªŒè¯æ•°æ®åº“è¿žæŽ¥å’Œæ•°æ®è´¨é‡

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-04
**åˆ†æžå¸ˆ**: Alpha006é¡¹ç›®ç»„