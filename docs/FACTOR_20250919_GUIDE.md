# 20250919因子计算使用指南

## 🎯 目标
计算20250919当日全量可交易股票的alpha_pluse和alpha_peg因子值，输出Excel文档。

---

## 📁 文件说明

### 主程序
- `code/calculate_factors_20250919.py` - 主计算脚本

### 测试程序
- `code/test_factors_20250919.py` - 逻辑验证脚本

### 输出目录
- `results/output/factor_values_20250919.xlsx` - 最终Excel文件

---

## 🚀 执行步骤

### 步骤1: 验证计算逻辑（推荐）
先用少量股票测试，确保计算逻辑正确：

```bash
cd /home/zcy/alpha006_20251223
python3 code/test_factors_20250919.py
```

**预期输出**:
- 显示3只测试股票的详细计算过程
- 验证alpha_pluse和alpha_peg计算结果

### 步骤2: 执行全量计算
确认逻辑无误后，运行完整计算：

```bash
python3 code/calculate_factors_20250919.py
```

**执行流程**:
1. ✅ 获取20250919可交易股票
2. ✅ 过滤ST、新股、停牌股票
3. ✅ 读取价格和成交量数据（往前32天）
4. ✅ 读取PE和财务数据
5. ✅ 计算alpha_pluse因子
6. ✅ 计算alpha_peg因子
7. ✅ 验证计算（随机抽样5-10只股票）
8. ✅ 导出Excel
9. ✅ 输出执行日志

---

## 📊 计算规则

### alpha_pluse计算
```
1. 回溯窗口: 20250919往前20个交易日
2. 判断条件: 每日成交量 ∈ [14日均值×1.4, 14日均值×3.5]
3. 统计数量: 20日内满足条件的天数
4. 赋值: 数量∈[2,4] → alpha_pluse=1，否则=0
```

**数据需求**:
- 最少需要32天历史数据（14日均值+20日窗口）
- 交易日必须连续

### alpha_peg计算
```
1. 原始值: alpha_peg = pe_ttm / dt_netprofit_yoy
2. 异常处理: dt_netprofit_yoy≤0 → 标记为NaN
3. 可选: 分行业排名/标准化（当前版本保留原始值）
```

**数据需求**:
- pe_ttm > 0
- dt_netprofit_yoy ≠ 0 且 ≠ NULL

---

## 📋 Excel输出格式

### 文件路径
```
\\wsl$\Ubuntu\home\zcy\alpha006_20251223\results\output\factor_values_20250919.xlsx
```

### 表格结构
| 股票代码 | 交易日 | alpha_pluse | 20日满足天数 | alpha_peg | 备注 |
|----------|--------|-------------|--------------|-----------|------|
| 600000.SH | 20250919 | 1 | 3 | 12.5000 | |
| 000001.SZ | 20250919 | 0 | 1 | NaN | dt_netprofit_yoy为负或零 |
| 600036.SH | 20250919 | 1 | 2 | 8.3000 | |

### 格式说明
- **alpha_pluse**: 整数 (0或1)
- **alpha_peg**: 保留4位小数
- **NaN值**: 显示为空，备注栏说明原因
- **表头**: 居中对齐
- **排序**: 按股票代码升序

---

## 📝 执行日志示例

```
================================================================================
获取20250919可交易股票
================================================================================
当日有交易记录的股票: 5000 只
ST股票: 150 只
上市不足6个月: 80 只
✅ 有效可交易股票: 4770 只
❌ 过滤股票: 230 只

================================================================================
获取价格和成交量数据
================================================================================
✓ 获取到 152,640 条价格数据
  股票数: 4770
  日期数: 32

================================================================================
获取财务数据
================================================================================
✓ PE数据: 4500 条
✓ 财务数据: 4600 条

================================================================================
计算alpha_pluse因子
================================================================================
✓ 计算完成: 4750 只股票
  信号数: 890
  信号比例: 0.1874

================================================================================
计算alpha_peg因子
================================================================================
✓ 计算完成: 4480 只股票
  异常值: 20 只

================================================================================
计算验证明细（随机抽样）
================================================================================

股票 600000.SH 最近20天计算明细:
日期           成交量      14日均值      满足     20日计数      alpha_pluse
--------------------------------------------------------------------------------
2025-08-21   1234567  1100000.00  ✓      1           0
2025-08-22   987654   1120000.00  ✗      1           0
...
2025-09-19   2345678  1500000.00  ✓      3           1

================================================================================
导出到Excel
================================================================================
✅ Excel文件已保存: /home/zcy/alpha006_20251223/results/output/factor_values_20250919.xlsx
  记录数: 4770

================================================================================
执行总结
================================================================================

📊 数据统计:
  目标日期: 20250919
  有效可交易股票: 4770 只
  alpha_pluse计算完成: 4750 只
  alpha_peg计算完成: 4480 只
  最终输出: 4770 只

📈 alpha_pluse统计:
  信号数: 890
  信号比例: 0.1874
  20日满足天数均值: 2.35

📊 alpha_peg统计:
  有效值: 4480
  均值: 15.2345
  中位数: 12.5000

⚠️  异常情况:
  过滤股票: 230 只
  数据不足: 20 只

✅ 输出文件: /home/zcy/alpha006_20251223/results/output/factor_values_20250919.xlsx

⏱️  执行耗时: 45.32 秒
```

---

## 🔍 结果验证

### Excel打开方式
1. **WSL路径**: `\\wsl$\Ubuntu\home\zcy\alpha006_20251223\results\output\`
2. **直接打开**: 在Windows资源管理器中输入路径
3. **使用Excel**: 双击打开 `factor_values_20250919.xlsx`

### 验证要点
1. ✅ 股票代码唯一性（无重复）
2. ✅ 交易日统一为20250919
3. ✅ alpha_pluse值为0或1
4. ✅ alpha_peg保留4位小数
5. ✅ NaN值有备注说明
6. ✅ 数据量与预期一致

### 抽样验证
随机抽取几只股票，手动验证：
```python
# 例如验证600000.SH
# 1. 查看20250919往前20天成交量
# 2. 计算每日14日均值
# 3. 统计满足条件的天数
# 4. 对比Excel中的count_20d和alpha_pluse
```

---

## ⚠️ 常见问题

### Q1: 数据不足怎么办？
**A**: 脚本会自动跳过数据不足的股票，并在日志中记录。最终Excel中不会包含这些股票。

### Q2: 为什么某些股票的alpha_peg为NaN？
**A**: 可能原因：
- dt_netprofit_yoy为负或零
- 无财务数据
- pe_ttm缺失或非正

### Q3: 交易日数据不完整？
**A**: 脚本会检查数据完整性，如果某股票在20250919往前32天内有缺失，会跳过并记录。

### Q4: 如何查看详细计算过程？
**A**: 运行测试脚本 `test_factors_20250919.py` 可查看3只股票的详细计算过程。

### Q5: Excel文件在哪里？
**A**: 路径为 `/home/zcy/alpha006_20251223/results/output/factor_values_20250919.xlsx`
在Windows中通过 `\\wsl$\Ubuntu\home\zcy\alpha006_20251223\results\output\` 访问。

---

## 📞 技术支持

如有问题，请检查：
1. 数据库连接是否正常
2. 20250919是否有交易数据
3. 财务数据是否更新到最新
4. 输出目录权限

---

**最后更新**: 2025-12-29
**版本**: v1.0
