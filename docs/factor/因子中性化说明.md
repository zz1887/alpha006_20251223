# 因子中性化处理说明

## 概述

在六大因子选股策略中，已实现**市值和行业中性化回归**，目的是剔除风格和行业暴露，检验因子的独立选股能力。

---

## 中性化公式

```
因子残差 = 原始因子 - β1 * 市值 - β2 * 行业哑变量
```

---

## 实现位置

**文件**: `/home/zcy/alpha006_20251223/scripts/run_six_factor.py`

**核心方法**:

### 1. `neutralize_factor()` - 单因子中性化
```python
def neutralize_factor(self, df, factor_col, market_cap_col='流通市值(亿)', industry_col='申万一级行业'):
    """
    因子中性化：剔除市值和行业暴露

    处理步骤：
    1. 对数市值转换：log(市值)
    2. 行业哑变量编码：pd.get_dummies()
    3. 线性回归：LinearRegression(fit_intercept=True)
    4. 计算残差：y - y_pred
    5. Z-Score标准化：(残差 - 均值) / 标准差
    """
```

### 2. `_neutralize_all_factors()` - 所有因子中性化
```python
def _neutralize_all_factors(self, df):
    """
    对6个因子依次进行中性化：
    - alpha_peg_zscore
    - alpha_010
    - alpha_038
    - alpha_120cq
    - cr_qfq
    """
```

### 3. `standardize_factor()` - Z-Score标准化
```python
def standardize_factor(self, series):
    """
    因子标准化：均值为0，标准差为1

    公式：Z = (X - μ) / σ
    """
```

---

## 策略执行流程

```
步骤1: 获取流通市值和成交额数据
       ↓
步骤2: 应用基础过滤
       ↓
步骤3: 计算6个原始因子
       ↓
步骤4: 因子中性化 ← 新增步骤
       ├─ alpha_peg → 中性化 → 替换原列
       ├─ alpha_010 → 中性化 → 替换原列
       ├─ alpha_038 → 中性化 → 替换原列
       ├─ alpha_120cq → 中性化 → 替换原列
       └─ cr_qfq → 中性化 → 替换原列
       ↓
步骤5: 因子筛选（使用中性化后的因子）
       ↓
步骤6: 计算加权综合得分
       ↓
步骤7: 导出Excel和日志
```

---

## 中性化技术细节

### 1. 特征构建

**市值特征**:
```python
df_neutral['log_mcap'] = np.log(df_neutral['流通市值(亿)'] + 1e-8)
```
- 使用对数市值，更符合线性假设
- 添加小常数避免log(0)

**行业特征**:
```python
industry_dummies = pd.get_dummies(df_neutral['申万一级行业'], prefix='industry')
```
- 独热编码（One-hot encoding）
- 每个行业一个二元变量

**特征矩阵**:
```python
X = pd.concat([
    df_neutral[['log_mcap']],      # 市值
    industry_dummies               # 行业哑变量
], axis=1)
```

### 2. 回归模型

```python
reg = LinearRegression(fit_intercept=True)
reg.fit(X, y)  # y = 原始因子值
```

- **线性回归**：最小二乘法
- **截距项**：True（允许非零截距）
- **R²统计**：记录回归拟合优度

### 3. 残差计算

```python
y_pred = reg.predict(X)
residual = y - y_pred
```

- **残差**：原始因子值 - 预测值
- **含义**：剔除市值和行业影响后的纯净因子

### 4. 标准化

```python
residual_zscore = (residual - residual_mean) / residual_std
```

- **均值**：0（标准化后）
- **标准差**：1（标准化后）
- **可比性**：不同因子可直接比较

---

## 输出结果

### Excel列说明

**原始因子**:
- `alpha_peg_zscore` - 估值因子（原始）
- `alpha_010` - 趋势因子（原始）
- `alpha_038` - 强度因子（原始）
- `alpha_120cq` - 位置因子（原始）
- `cr_qfq` - 动量因子（原始）

**中性化后因子**:
- `alpha_peg_neutral` - 估值因子（中性化+标准化）
- `alpha_010_neutral` - 趋势因子（中性化+标准化）
- `alpha_038_neutral` - 强度因子（中性化+标准化）
- `alpha_120cq_neutral` - 位置因子（中性化+标准化）
- `cr_qfq_neutral` - 动量因子（中性化+标准化）

**标准化因子**（用于打分）:
- `因子_估值` - [0,1]区间
- `因子_趋势` - [0,1]区间
- `因子_强度` - [0,1]区间
- `因子_位置` - [0,1]区间
- `因子_动量` - [0,1]区间

### 日志输出示例

```
步骤4: 因子中性化...
  开始因子中性化处理...
  中性化因子: alpha_peg_zscore
  alpha_peg_zscore 中性化完成:
    回归R²: 0.1234
    残差均值: 0.000000
    残差标准差: 0.8765
    中性化后均值: 0.000000
    中性化后标准差: 1.000000
  alpha_peg_zscore 已替换为中性化版本
  ...
  因子中性化完成
```

---

## 中性化效果验证

### 验证指标

1. **回归R²**: 衡量市值和行业对因子的解释程度
   - R²高（>0.3）：因子受市值/行业影响大，中性化必要
   - R²低（<0.1）：因子相对纯净

2. **残差均值**: 应为0（标准化后）

3. **残差标准差**: 反映因子波动性

4. **中性化前后对比**:
   - 均值：0 → 0
   - 标准差：可能变化 → 1

### 使用场景

**中性化前**:
- 大市值因子可能偏向银行、保险
- 特定行业（如新能源）可能过度暴露

**中性化后**:
- 剔除市值和行业偏见
- 纯粹反映因子自身选股能力
- 跨行业、跨市值公平比较

---

## 注意事项

### 1. 数据要求

- **最小样本量**: 10只股票（否则跳过中性化）
- **行业分布**: 每个行业至少2只股票（回归需要）
- **市值范围**: 不能全部相同（否则无法回归）

### 2. 边界情况处理

```python
if len(df_neutral) < 10:
    logger.warning(f"数据量不足({len(df_neutral)}条)，跳过中性化")
    return df

if residual_std == 0:
    residual_zscore = residual * 0  # 全部设为0
```

### 3. 性能考虑

- 线性回归复杂度：O(n * p²)，n=样本数，p=特征数
- 5000只股票 + 50个行业 ≈ 100ms/因子
- 6个因子 ≈ 1秒

### 4. sklearn依赖

```bash
pip install scikit-learn
```

---

## 完整执行示例

```bash
# 进入项目目录
cd /home/zcy/alpha006_20251223

# 执行策略（自动进行中性化）
python scripts/run_six_factor.py --date 20251230 --version standard
```

**执行日志**:
```
================================================================================
六大因子选股策略
================================================================================
日期: 20251230
版本: standard
================================================================================

步骤1: 获取流通市值和成交额数据...
获取市值/成交额数据: 4500只股票

步骤2: 应用基础过滤...
基础过滤后剩余: 3855只股票

步骤3: 计算各因子...
  计算alpha_peg...
  计算alpha_010...
  计算alpha_038...
  计算alpha_120cq...
  获取cr_qfq...
因子数据统计:
  alpha_peg_zscore: 3855/3855 有效, 均值=0.00
  alpha_010: 3855/3855 有效, 均值=0.12
  alpha_038: 3855/3855 有效, 均值=-0.05
  alpha_120cq: 3855/3855 有效, 均值=0.50
  cr_qfq: 3855/3855 有效, 均值=0.08

步骤4: 因子中性化...
  开始因子中性化处理...
  中性化因子: alpha_peg_zscore
  alpha_peg_zscore 中性化完成:
    回归R²: 0.1234
    残差均值: 0.000000
    残差标准差: 0.8765
    中性化后均值: 0.000000
    中性化后标准差: 1.000000
  alpha_peg_zscore 已替换为中性化版本
  中性化因子: alpha_010
  alpha_010 中性化完成:
    回归R²: 0.0892
    残差均值: 0.000000
    残差标准差: 0.9231
    中性化后均值: 0.000000
    中性化后标准差: 1.000000
  alpha_010 已替换为中性化版本
  ...
  因子中性化完成

步骤5: 应用因子筛选...
因子筛选后剩余: 27只股票

步骤6: 计算加权综合得分...
综合得分范围: 0.2345 ~ 0.8765

步骤7: 导出Excel...
完整结果已保存: .../six_factor_scores_20251230_103000.xlsx
前100名已保存: .../six_factor_top100_20251230_103000.xlsx
筛选日志已保存: .../six_factor_log_20251230_103000.xlsx

================================================================================
执行总结
================================================================================
📊 数据统计:
  目标日期: 20251230
  策略版本: standard
  最终选股: 27只

📈 综合得分统计:
  均值: 0.5432
  标准差: 0.1567
  最小值: 0.2345
  最大值: 0.8765

📝 前10名优质个股:
  600519.SH  食品饮料  得分=0.8765
  000858.SZ  食品饮料  得分=0.8432
  ...

✅ 任务完成！
```

---

## 技术优势

### 1. 纯净因子

中性化后，因子不再受以下因素影响：
- ✅ 市值大小（大/小盘效应）
- ✅ 行业属性（金融/消费/科技等）
- ✅ 风格暴露（价值/成长/动量等）

### 2. 跨市场可比

不同行业、不同市值的股票可以公平比较因子得分。

### 3. 稳定性

中性化后的因子在不同市场环境下表现更稳定。

### 4. 可解释性

残差回归的R²可以量化因子的"纯净度"。

---

## 扩展建议

### 1. 添加更多控制变量

```python
# 可以添加
- 波动率（Volatility）
- 换手率（Turnover）
- 估值分位数（PE Percentile）
- 成长性（Growth）
```

### 2. 动态权重

根据R²调整因子权重：
```python
weight = original_weight * (1 - R²)  # R²越高，权重越低
```

### 3. 行业分层

```python
# 按行业分组中性化
for industry in industries:
    industry_df = df[df['行业'] == industry]
    # 在行业内进行市值中性化
```

---

## 总结

**已完成**:
- ✅ 实现 `neutralize_factor()` - 单因子中性化
- ✅ 实现 `_neutralize_all_factors()` - 批量中性化
- ✅ 实现 `standardize_factor()` - Z-Score标准化
- ✅ 集成到策略执行流程
- ✅ 输出中性化后因子到Excel
- ✅ 记录回归统计信息

**效果**:
- 因子剔除市值和行业暴露
- 输出标准化Z-Score（均值0，标准差1）
- 保留原始因子和中性化因子供对比

**执行命令**:
```bash
python scripts/run_six_factor.py --date 20251230 --version standard
```

---

**更新时间**: 2025-12-31
**实现版本**: v2.0（含中性化）
