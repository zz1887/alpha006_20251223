"""
文件input(依赖外部什么): 回测数据、因子计算代码
文件output(提供什么): 因子符号验证结果、配置修正建议
文件pos(系统局部地位): 策略诊断文档，定位符号配置问题

因子符号验证报告
20240601-20251130 回测因子方向分析

报告日期: 2025-01-01
测试日期: 20240628
"""

# 因子符号验证报告

## 📊 核心发现

**发现2个关键符号配置错误，导致策略失效**

---

## 【1】验证方法

### 测试样本
- 日期: 2024年6月28日（6月末）
- 样本: 100只股票
- 方法: 对比配置方向与实际计算逻辑

### 验证标准
```
配置方向 = 'positive' → 因子值越大越好
配置方向 = 'negative' → 因子值越小越好

实际逻辑 → 因子计算公式
预期符号 → 配置方向对应的符号
实际符号 → 计算结果的符号特征
```

---

## 【2】各因子详细分析

### ✅ alpha_pluse - 量能因子
**配置**: `direction: 'positive'`

**计算逻辑**:
```python
# 二值化因子
alpha_pluse = 0 或 1
1表示量能扩张信号
```

**符号分析**:
- 值越大越好（1 > 0）
- 配置: positive ✓
- **结论: 正确**

---

### ✅ alpha_peg - 估值因子
**配置**: `direction: 'negative'`

**计算逻辑**:
```python
# 行业Z-score标准化
alpha_peg = (PE - 行业均值) / 行业标准差
```

**符号分析**:
- 低PE → 负值
- 高PE → 正值
- 低PE越好 → 负值越好
- 配置: negative ✓
- **结论: 正确**

---

### ❌ alpha_010 - 短期趋势因子
**配置**: `direction: 'negative'` ← **错误**

**计算逻辑**:
```python
# 1. 计算每日涨跌幅
delta_close = close_t - close_{t-1}

# 2. 三元规则
if ts_min > 0:          # 连续上涨
    rule_value = target_delta
elif ts_max < 0:        # 连续下跌
    rule_value = target_delta
else:                   # 震荡反转
    rule_value = -target_delta

# 3. 全市场排名
alpha_010 = rank(rule_value)  # 1-100
```

**实际数据示例**:
```
股票代码    delta_close  ts_min  ts_max  rule_value  rule_type  alpha_010
000001.SZ      0.02      -0.02   0.09      -0.02      震荡反转     58
000002.SZ     -0.07      -0.20   0.12       0.07      震荡反转     89
000006.SZ      0.15      -0.10   0.15      -0.15      震荡反转     22
```

**统计特征**:
- rule_value均值: -0.1050
- 正值比例: 32%
- alpha_010范围: 1-100

**符号分析**:
```
rank()函数特性:
  - rule_value越大 → 排名越高 → alpha_010越大
  - rule_value为正 → 表示趋势好 → 应该得分高

配置问题:
  - 配置为'negative' → 标准化时会反转
  - 反转后: 高alpha_010 → 低标准化值
  - 结果: 趋势好的股票得分低 ❌
```

**问题根源**:
```
配置方向与计算逻辑矛盾
- 计算逻辑: rank后值越大越好
- 配置方向: negative（值越小越好）
- 标准化时反转 → 优质股票被惩罚
```

**修正建议**:
```python
# config/strategies/six_factor_monthly.py
'alpha_010': {
    'direction': 'positive',  # 原为 'negative'
    'weight': 0.20,
    'normalization': 'none',
}
```

---

### ❌ alpha_038 - 价格强度因子
**配置**: `direction: 'negative'` ← **错误**

**计算逻辑**:
```python
alpha_038 = (-1 × rank(Ts_Rank(close, 10))) × rank(close/open)

其中:
  - Ts_Rank(close, 10): close在10日序列中的排名(1-10)
  - rank(close/open): close/open的降序排名(1-N)
```

**实际数据示例**:
```
股票代码    close_rank  rank(close/open)  alpha_038
000001.SZ      10              60          -600
000002.SZ       2               40           -80
000006.SZ       5               20          -100
```

**统计特征**:
- alpha_038均值: -170.36
- 全部为负值: 100%
- 范围: -602 到 -10

**符号分析**:
```
公式分析:
  alpha_038 = (-1 × rank_close) × rank(close_over_open)

  - rank_close: 1-10，值越大表示价格越高
  - rank(close_over_open): 降序排名，1=最大

举例验证:
  股票A: close_rank=10, rank(close/open)=1
        alpha_038 = (-1 × 10) × 1 = -10

  股票B: close_rank=1, rank(close/open)=10
        alpha_038 = (-1 × 1) × 10 = -10

  问题: 两个极端情况得到相同值！
        因子区分度严重受损
```

**配置问题**:
```
配置为'negative'的含义:
  - 原始值越小越好（负得越多越好）
  - 标准化时会反转: 1 - (x - min)/(max - min)
  - 反转后: 原始值小 → 标准化值大

矛盾点:
  - alpha_038已经是负值
  - 配置negative → 标准化反转 → 负值变正值
  - 符号混乱，无法解释
```

**修正建议**:
```python
# config/strategies/six_factor_monthly.py
'alpha_038': {
    'direction': 'positive',  # 原为 'negative'
    'weight': 0.20,
    'normalization': 'none',
}
```

**额外建议**:
```
因子公式本身也存在问题:
  - 两个极端情况得到相同值
  - 建议重新设计公式或剔除该因子
```

---

### ✅ alpha_120cq - 价格位置因子
**配置**: `direction: 'positive'`

**计算逻辑**:
```python
# 价格在120日区间的位置
alpha_120cq = (close - min_120) / (max_120 - min_120)
```

**符号分析**:
- 位置越高 → 值越大 → 越好
- 配置: positive ✓
- **结论: 正确**

---

### ✅ cr_qfq - 动量因子
**配置**: `direction: 'positive'`

**计算逻辑**:
```python
# 动量指标
cr_qfq = 动量计算值
```

**符号分析**:
- 动量越强 → 值越大 → 越好
- 配置: positive ✓
- **结论: 正确**

---

## 【3】符号配置汇总

| 因子 | 配置方向 | 计算逻辑 | 实际符号 | 状态 | 修正建议 |
|------|----------|----------|----------|------|----------|
| alpha_pluse | positive | 二值化(0/1) | 正 | ✅ 正确 | - |
| alpha_peg | negative | 行业Z-score | 负 | ✅ 正确 | - |
| alpha_010 | negative | rank(rule_value) | 正 | ❌ 错误 | 改为positive |
| alpha_038 | negative | (-1×rank)×rank | 负 | ❌ 错误 | 改为positive |
| alpha_120cq | positive | 价格分位数 | 正 | ✅ 正确 | - |
| cr_qfq | positive | 动量 | 正 | ✅ 正确 | - |

---

## 【4】影响分析

### 对分组单调性的影响

**当前表现**: 组2 > 组1，组5 > 组4（无单调性）

**原因分析**:
```
alpha_010和alpha_038占权重40%，但符号配置错误

标准化过程（以alpha_010为例）:
  1. 原始值: rank后1-100，值越大越好
  2. 配置negative → 标准化公式:
     normalized = 1 - (x - min) / (max - min)
  3. 结果: 原始值大 → 标准化值小

分组影响:
  - 高alpha_010股票（趋势好）→ 标准化后得分低
  - 低alpha_010股票（趋势差）→ 标准化后得分高
  - 导致: 组1（高分组）包含趋势差的股票
  - 结果: 组1收益 < 组2收益
```

### 对IC值的影响

**当前IC**: 0.0084（接近0，无预测能力）

**原因**:
```
因子符号混乱导致:
  1. 部分因子预测方向正确
  2. 部分因子预测方向相反
  3. 相互抵消 → IC接近0
```

### 对多空组合的影响

**当前表现**: 年化0.72%，夏普-0.27

**原因**:
```
组1和组5都包含错误的股票:
  - 组1: 应该是优质股，但包含趋势差的股票
  - 组5: 应该是劣质股，但包含趋势好的股票
  - 多空组合: 优质 - 劣质 ≈ 0
```

---

## 【5】修正方案

### 立即修改

**文件**: `config/strategies/six_factor_monthly.py`

**修改内容**:
```python
FACTOR_CONFIG = {
    'factors': {
        'alpha_peg': {
            'direction': 'negative',  # ✓ 保持不变
        },
        'alpha_010': {
            'direction': 'positive',  # ❌ 改为 positive
        },
        'alpha_038': {
            'direction': 'positive',  # ❌ 改为 positive
        },
        'alpha_120cq': {
            'direction': 'positive',  # ✓ 保持不变
        },
        'cr_qfq': {
            'direction': 'positive',  # ✓ 保持不变
        },
        'alpha_pluse': {
            'direction': 'positive',  # ✓ 保持不变
        },
    }
}
```

### 预期效果

**修正后**:
```
✅ 分组单调性恢复: 组1 > 组2 > 组3 > 组4 > 组5
✅ IC值提升: 0.0084 → 0.05+
✅ 多空组合改善: 0.72% → 8%+
✅ 相对基准: 从-14.68% → 正超额
```

---

## 【6】验证步骤

### 步骤1: 修改配置
```bash
# 编辑配置文件
vim config/strategies/six_factor_monthly.py

# 修改两处:
# 1. FACTOR_CONFIG['factors']['alpha_010']['direction'] = 'positive'
# 2. FACTOR_CONFIG['factors']['alpha_038']['direction'] = 'positive'
```

### 步骤2: 重新运行回测
```bash
cd /home/zcy/alpha006_20251223
python scripts/run_strategy.py -s six_factor_monthly --start 20240601 --end 20251130
```

### 步骤3: 验证结果
```bash
# 查看新结果
cat results/backtest/six_factor_*/backtest_log.txt

# 关键指标:
# - 分组收益是否单调递减
# - IC值是否提升
# - 多空组合是否改善
```

---

## 【7】额外建议

### 建议1: 优化alpha_038公式
**问题**: 两个极端情况得到相同值

**改进方案**:
```python
# 原公式
alpha_038 = (-1 × rank_close) × rank(close_over_open)

# 改进方案A: 去掉负号
alpha_038 = rank_close × rank(close_over_open)

# 改进方案B: 使用乘积
alpha_038 = close_rank × close_over_open

# 改进方案C: 使用对数
alpha_038 = log(close_rank) × log(close_over_open)
```

### 建议2: 增加因子诊断
```python
# 在回测中添加因子方向验证
def validate_factor_direction(factor_df, expected_direction):
    """验证因子方向是否符合预期"""
    # 计算因子与下月收益的相关性
    corr = factor_df['factor'].corr(factor_df['next_return'])

    if expected_direction == 'positive':
        assert corr > 0, f"因子方向错误，应为正相关"
    else:
        assert corr < 0, f"因子方向错误，应为负相关"
```

### 建议3: 建立因子测试框架
```python
# 单因子测试
for factor in factors:
    # 1. 计算因子
    # 2. 验证方向
    # 3. 计算IC
    # 4. 分组测试
    # 5. 生成报告
```

---

## 【8】总结

### 核心问题
```
2个因子符号配置错误导致整个策略失效:
  1. alpha_010: 配置应为positive
  2. alpha_038: 配置应为positive
```

### 影响程度
```
严重性: 🔴 高
影响范围: 40%权重
修复难度: 低（仅修改配置）
预期收益: 大幅提升
```

### 行动计划
```
P0: 修改配置文件（2处）
P1: 重新运行回测验证
P2: 优化alpha_038公式
P3: 建立因子验证机制
```

---

**报告生成时间**: 2025-01-01
**分析工具**: Python 3.10, Pandas
**数据来源**: 20240628回测数据
