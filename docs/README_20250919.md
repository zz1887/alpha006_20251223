# 20250919因子计算项目

## 🎯 项目目标
计算20250919当日全量可交易股票的alpha_pluse和alpha_peg因子值，输出Excel文档。

---

## 📁 项目文件

### 核心脚本
| 文件 | 说明 |
|------|------|
| `code/calculate_factors_20250919.py` | 主计算程序（完整功能） |
| `code/run_20250919_quick.py` | 快速执行脚本 |
| `code/test_factors_20250919.py` | 逻辑验证脚本 |

### 文档
| 文件 | 说明 |
|------|------|
| `docs/FACTOR_20250919_GUIDE.md` | 详细使用指南 |
| `docs/factor_alpha_pluse.md` | alpha_pluse因子字典 |
| `docs/factor_dictionary.md` | alpha_peg因子字典 |

### 输出
| 路径 | 说明 |
|------|------|
| `results/output/factor_values_20250919.xlsx` | 最终Excel文件 |

---

## 🚀 快速开始

### 方式1: 一键执行（推荐）
```bash
cd /home/zcy/alpha006_20251223
python3 code/run_20250919_quick.py
```

### 方式2: 分步执行

**步骤1: 验证逻辑**
```bash
python3 code/test_factors_20250919.py
```

**步骤2: 完整计算**
```bash
python3 code/calculate_factors_20250919.py
```

---

## 📊 计算规则

### alpha_pluse
```
1. 回溯窗口: 20250919往前20个交易日
2. 判断条件: vol ∈ [14日均值×1.4, 14日均值×3.5]
3. 统计数量: 20日内满足条件的天数
4. 赋值: 数量∈[2,4] → 1，否则→0
```

### alpha_peg
```
1. 原始值: alpha_peg = pe_ttm / dt_netprofit_yoy
2. 异常处理: dt_netprofit_yoy≤0 → NaN
3. 前向填充: 使用最近一期已公告财报
```

---

## 📈 输出格式

### Excel文件路径
```
\\wsl$\Ubuntu\home\zcy\alpha006_20251223\results\output\factor_values_20250919.xlsx
```

### 表格结构
| 股票代码 | 交易日 | alpha_pluse | 20日满足天数 | alpha_peg | 备注 |
|----------|--------|-------------|--------------|-----------|------|
| 600000.SH | 20250919 | 1 | 4 | 12.5000 | |
| 000001.SZ | 20250919 | 0 | 1 | NaN | dt_netprofit_yoy为负或零 |

---

## ✅ 验证结果

### 测试脚本输出（2025-12-29）
```
股票 000001.SZ: alpha_pluse=0, count_20d=1.0 ✅
股票 600000.SH: alpha_pluse=1, count_20d=4.0 ✅
股票 600036.SH: alpha_pluse=1, count_20d=3.0 ✅
```

### 逻辑验证
- ✅ alpha_pluse计算正确（基于20日窗口统计）
- ✅ alpha_peg计算正确（前向填充财务数据）
- ✅ 数据过滤正确（ST、新股、停牌）
- ✅ Excel输出格式正确

---

## 🔍 数据处理流程

```
1. 数据读取
   ├─ 获取20250919可交易股票
   ├─ 过滤ST、新股、停牌
   └─ 获取往前32天价格数据

2. alpha_pluse计算
   ├─ 计算14日成交量均值
   ├─ 标记满足条件的交易日
   ├─ 统计20日窗口内数量
   └─ 赋值0/1

3. alpha_peg计算
   ├─ 获取PE数据
   ├─ 获取财务数据（前向填充）
   ├─ 计算原始值
   └─ 处理异常值

4. 输出Excel
   ├─ 合并结果
   ├─ 格式化
   └─ 保存文件
```

---

## 📝 执行日志示例

```
================================================================================
步骤1: 获取20250919可交易股票
================================================================================
当日有交易记录的股票: 5000 只
ST股票: 150 只
上市不足6个月: 80 只
✅ 有效可交易股票: 4770 只

================================================================================
步骤2: 获取价格和成交量数据
================================================================================
✓ 获取到 152,640 条价格数据

================================================================================
步骤3: 获取财务数据
================================================================================
✓ PE数据: 4500 条
✓ 财务数据: 4600 条

================================================================================
步骤4: 计算alpha_pluse因子
================================================================================
✓ 计算完成: 4750 只股票
  信号数: 890 (18.74%)

================================================================================
步骤5: 计算alpha_peg因子
================================================================================
✓ 计算完成: 4480 只股票
  异常值: 20 只

================================================================================
步骤6: 导出到Excel
================================================================================
✅ Excel文件已保存
  记录数: 4770

执行耗时: 45.32 秒
```

---

## ⚠️ 注意事项

### 数据要求
- **最小历史数据**: 32个交易日（alpha_pluse）
- **财务数据**: 需要在20250919之前已公告
- **PE数据**: 必须为正数

### 常见问题

**Q: 如何访问Excel文件？**
A: 在Windows资源管理器中输入：
```
\\wsl$\Ubuntu\home\zcy\alpha006_20251223\results\output\
```

**Q: 某些股票无alpha_peg值？**
A: 可能原因：
- dt_netprofit_yoy为负或零
- 无财务数据
- pe_ttm缺失

**Q: 数据不足怎么办？**
A: 脚本会自动跳过，并在日志中记录。

---

## 🛠️ 调试和验证

### 查看详细计算过程
运行测试脚本查看3只股票的详细计算：
```bash
python3 code/test_factors_20250919.py
```

### 手动验证
在Excel中随机抽取股票，手动验证：
1. 查看20250919往前20天成交量
2. 计算每日14日均值
3. 统计满足条件的天数
4. 对比Excel中的count_20d和alpha_pluse

---

## 📞 技术支持

如有问题，请检查：
1. � 数据库连接正常
2. � 20250919有交易数据
3. � 财务数据已更新
4. � 输出目录有写入权限

---

## 📅 项目时间线

- **2025-12-29**: 项目创建
  - 完成alpha_pluse因子实现
  - 完成alpha_peg因子实现
  - 完成Excel输出功能
  - 完成验证测试

---

## 📚 相关文档

- [alpha_pluse因子字典](docs/factor_alpha_pluse.md)
- [alpha_peg因子字典](docs/factor_dictionary.md)
- [详细使用指南](docs/FACTOR_20250919_GUIDE.md)
- [实现总结](docs/ALPHA_PLUSE_IMPLEMENTATION.md)

---

**版本**: v1.0
**创建日期**: 2025-12-29
**状态**: ✅ 完成
